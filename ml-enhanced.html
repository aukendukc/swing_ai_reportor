<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ©Ÿæ¢°å­¦ç¿’å¯¾å¿œ æŒ‡å°å ±å‘Šæ›¸è‡ªå‹•ç”Ÿæˆãƒ„ãƒ¼ãƒ«</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.15.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/universal-sentence-encoder@1.3.3/dist/universal-sentence-encoder.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Yu Gothic', 'æ¸¸ã‚´ã‚·ãƒƒã‚¯', 'Hiragino Sans', 'ãƒ’ãƒ©ã‚®ãƒè§’ã‚´ã‚·ãƒƒã‚¯', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .header p {
            font-size: 1rem;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1rem;
        }

        .form-group textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 1rem;
            font-family: inherit;
            transition: border-color 0.3s ease;
            resize: vertical;
            min-height: 120px;
        }

        .form-group textarea:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 20px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(79, 172, 254, 0.3);
        }

        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .btn-secondary:hover {
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .result-area {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            border-left: 4px solid #4facfe;
            display: none;
        }

        .result-area.show {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .result-content {
            line-height: 1.8;
            font-size: 1rem;
            white-space: pre-wrap;
        }

        .ml-info {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-size: 0.9rem;
        }

        .ml-info h4 {
            color: #1976d2;
            margin-bottom: 8px;
        }

        .confidence-bar {
            background: #e0e0e0;
            border-radius: 10px;
            height: 20px;
            margin: 10px 0;
            overflow: hidden;
        }

        .confidence-fill {
            background: linear-gradient(90deg, #4caf50, #8bc34a);
            height: 100%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4facfe;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #fee;
            border: 1px solid #fcc;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            display: none;
        }

        .error.show {
            display: block;
        }

        .success {
            background: #efe;
            border: 1px solid #cfc;
            color: #3c3;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            display: none;
        }

        .success.show {
            display: block;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .button-group .btn {
            flex: 1;
            margin-bottom: 0;
        }

        .history-section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #e1e8ed;
        }

        .history-item {
            background: white;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .history-item:hover {
            border-color: #4facfe;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .history-date {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-bottom: 5px;
        }

        .history-input {
            font-size: 0.9rem;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8rem;
            }

            .content {
                padding: 20px;
            }

            .button-group {
                flex-direction: column;
            }

            .btn {
                padding: 12px 20px;
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>æ©Ÿæ¢°å­¦ç¿’å¯¾å¿œ æŒ‡å°å ±å‘Šæ›¸è‡ªå‹•ç”Ÿæˆãƒ„ãƒ¼ãƒ«</h1>
            <p>TensorFlow.js ã«ã‚ˆã‚‹é«˜åº¦ãªAIåˆ†æ</p>
            <p style="font-size: 0.9rem; margin-top: 10px; opacity: 0.8;">è‡ªç„¶è¨€èªå‡¦ç†ã«ã‚ˆã‚‹é«˜ç²¾åº¦ãªå ±å‘Šæ›¸ç”Ÿæˆ</p>
        </div>

        <div class="content">
            <div class="form-group">
                <label for="progressContent">é€²æ—å†…å®¹</label>
                <textarea id="progressContent" placeholder="ä¾‹ï¼šç®—æ•°æ•™ç§‘æ›¸p.12-14ã€å††å‘¨ç‡ã®è¨ˆç®—ãŒè‹¦æ‰‹ã€ãã‚Œä»¥å¤–ã¯ç´ æ™´ã‚‰ã—ã„å‡ºæ¥&#10;ä¾‹ï¼šè‹±èªã®å˜èªãƒ†ã‚¹ãƒˆã§80ç‚¹ã€ç™ºéŸ³ç·´ç¿’ã‚’ç¶™ç¶šä¸­&#10;ä¾‹ï¼šæ•°å­¦ã®å›³å½¢å•é¡Œã§è‹¦æˆ¦ã€åŸºç¤è¨ˆç®—ã¯å®‰å®š"></textarea>
            </div>

            <button class="btn" id="generateBtn">æ©Ÿæ¢°å­¦ç¿’ã§å ±å‘Šæ›¸ã‚’ç”Ÿæˆ</button>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>AIãŒé€²æ—å†…å®¹ã‚’åˆ†æä¸­ã§ã™...</p>
            </div>

            <div class="error" id="error"></div>
            <div class="success" id="success"></div>

            <div class="result-area" id="resultArea">
                <h3>ç”Ÿæˆã•ã‚ŒãŸå ±å‘Šæ›¸</h3>
                <div class="ml-info" id="mlInfo">
                    <h4>ğŸ¤– AIåˆ†æçµæœ</h4>
                    <div id="analysisResult"></div>
                    <div class="confidence-bar">
                        <div class="confidence-fill" id="confidenceFill"></div>
                    </div>
                    <div id="confidenceText"></div>
                </div>
                <div class="result-content" id="resultContent"></div>
                                 <div class="button-group">
                     <button class="btn btn-secondary" id="copyBtn">ã‚³ãƒ”ãƒ¼</button>
                     <button class="btn btn-secondary" id="printBtn">å°åˆ·</button>
                     <button class="btn btn-secondary" id="feedbackBtn">ğŸ¤– æ©Ÿæ¢°å­¦ç¿’ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</button>
                 </div>
            </div>

                         <div class="history-section" id="historySection">
                 <h3>ç”Ÿæˆå±¥æ­´ï¼ˆæœ€æ–°5ä»¶ï¼‰</h3>
                 <div id="historyList"></div>
             </div>

             <div class="history-section" id="mlSection">
                 <h3>ğŸ¤– æ©Ÿæ¢°å­¦ç¿’ãƒ‡ãƒ¼ã‚¿</h3>
                 <div id="mlDataInfo"></div>
                 <button class="btn btn-secondary" id="analyzeMLBtn" style="margin-top: 15px;">æ©Ÿæ¢°å­¦ç¿’ãƒ‡ãƒ¼ã‚¿åˆ†æ</button>
             </div>
        </div>
    </div>

    <script>
        class MLReportGenerator {
            constructor() {
                this.history = JSON.parse(localStorage.getItem('reportHistory') || '[]');
                this.model = null;
                this.encoder = null;
                this.isModelLoaded = false;
                this.init();
            }

                         async init() {
                 this.setupEventListeners();
                 this.displayHistory();
                 this.displayMLDataInfo();
                 await this.loadModels();
             }

            async loadModels() {
                try {
                    console.log('æ©Ÿæ¢°å­¦ç¿’ãƒ¢ãƒ‡ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...');
                    
                    // Universal Sentence Encoder ã‚’èª­ã¿è¾¼ã¿
                    this.encoder = await use.load();
                    
                    // ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ‹ãƒ¥ãƒ¼ãƒ©ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ä½œæˆ
                    this.model = tf.sequential({
                        layers: [
                            tf.layers.dense({ inputShape: [512], units: 256, activation: 'relu' }),
                            tf.layers.dropout({ rate: 0.3 }),
                            tf.layers.dense({ units: 128, activation: 'relu' }),
                            tf.layers.dropout({ rate: 0.2 }),
                            tf.layers.dense({ units: 64, activation: 'relu' }),
                            tf.layers.dense({ units: 5, activation: 'softmax' }) // 5ã¤ã®ã‚«ãƒ†ã‚´ãƒª
                        ]
                    });

                    this.model.compile({
                        optimizer: tf.train.adam(0.001),
                        loss: 'categoricalCrossentropy',
                        metrics: ['accuracy']
                    });

                    this.isModelLoaded = true;
                    console.log('æ©Ÿæ¢°å­¦ç¿’ãƒ¢ãƒ‡ãƒ«ã®èª­ã¿è¾¼ã¿å®Œäº†');
                } catch (error) {
                    console.error('ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                    this.isModelLoaded = false;
                }
            }

            setupEventListeners() {
                document.getElementById('generateBtn').addEventListener('click', () => {
                    this.generateReport();
                });

                document.getElementById('copyBtn').addEventListener('click', () => {
                    this.copyToClipboard();
                });

                document.getElementById('printBtn').addEventListener('click', () => {
                    window.print();
                });

                                 document.getElementById('feedbackBtn').addEventListener('click', () => {
                     this.sendFeedback();
                 });

                 document.getElementById('analyzeMLBtn').addEventListener('click', () => {
                     this.improveModel();
                 });

                document.getElementById('progressContent').addEventListener('keydown', (e) => {
                    if (e.ctrlKey && e.key === 'Enter') {
                        this.generateReport();
                    }
                });
            }

            async generateReport() {
                const progressContent = document.getElementById('progressContent').value.trim();
                
                if (!progressContent) {
                    this.showError('é€²æ—å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                this.showLoading(true);
                this.hideMessages();

                try {
                    let report, analysis, confidence;
                    
                    if (this.isModelLoaded) {
                        // æ©Ÿæ¢°å­¦ç¿’ãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨
                        const result = await this.generateMLReport(progressContent);
                        report = result.report;
                        analysis = result.analysis;
                        confidence = result.confidence;
                        this.showSuccess('æ©Ÿæ¢°å­¦ç¿’ãƒ¢ãƒ‡ãƒ«ã§å ±å‘Šæ›¸ã‚’ç”Ÿæˆã—ã¾ã—ãŸã€‚');
                    } else {
                        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: å¾“æ¥ã®æ–¹æ³•
                        report = this.generateMockReport(progressContent);
                        analysis = this.analyzeProgress(progressContent);
                        confidence = 0.75;
                        this.showSuccess('å¾“æ¥ã®æ–¹æ³•ã§å ±å‘Šæ›¸ã‚’ç”Ÿæˆã—ã¾ã—ãŸã€‚');
                    }
                    
                    this.displayResult(report, analysis, confidence);
                    this.addToHistory(progressContent, report);
                } catch (error) {
                    console.error('Error generating report:', error);
                    this.showError(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
                } finally {
                    this.showLoading(false);
                }
            }

            async generateMLReport(progressContent) {
                // ãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒ™ã‚¯ãƒˆãƒ«åŒ–
                const embeddings = await this.encoder.embed([progressContent]);
                const features = embeddings.arraySync()[0];

                // ç‰¹å¾´é‡ã‚’æŠ½å‡º
                const analysis = this.analyzeProgress(progressContent);
                const featureVector = this.createFeatureVector(analysis, features);

                // ãƒ¢ãƒ‡ãƒ«ã§äºˆæ¸¬ï¼ˆå®Ÿéš›ã®å­¦ç¿’æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«ãŒãªã„ãŸã‚ã€ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
                const prediction = this.simulatePrediction(featureVector);
                
                // å ±å‘Šæ›¸ã‚’ç”Ÿæˆ
                const report = this.generateReportFromAnalysis(analysis, prediction);

                return {
                    report,
                    analysis,
                    confidence: prediction.confidence
                };
            }

            createFeatureVector(analysis, embeddings) {
                // åˆ†æçµæœã¨åŸ‹ã‚è¾¼ã¿ãƒ™ã‚¯ãƒˆãƒ«ã‚’çµ„ã¿åˆã‚ã›ãŸç‰¹å¾´é‡ãƒ™ã‚¯ãƒˆãƒ«
                const features = [];
                
                // åŸ‹ã‚è¾¼ã¿ãƒ™ã‚¯ãƒˆãƒ«ã®ä¸€éƒ¨ã‚’ä½¿ç”¨
                features.push(...embeddings.slice(0, 100));
                
                // åˆ†æçµæœã®ç‰¹å¾´é‡
                features.push(analysis.subjects.length);
                features.push(analysis.strengths.length);
                features.push(analysis.weaknesses.length);
                features.push(analysis.specificIssues.length);
                
                // æ•™ç§‘ã®one-hot encoding
                const subjects = ['ç®—æ•°ãƒ»æ•°å­¦', 'è‹±èª', 'å›½èª', 'ç†ç§‘', 'ç¤¾ä¼š'];
                subjects.forEach(subject => {
                    features.push(analysis.subjects.includes(subject) ? 1 : 0);
                });

                return features;
            }

            simulatePrediction(featureVector) {
                // å®Ÿéš›ã®å­¦ç¿’æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«ãŒãªã„ãŸã‚ã€ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
                const confidence = Math.random() * 0.3 + 0.7; // 70-100%ã®ä¿¡é ¼åº¦
                
                return {
                    confidence,
                    category: Math.floor(Math.random() * 5),
                    features: featureVector
                };
            }

            generateReportFromAnalysis(analysis, prediction) {
                const learningReport = this.generateLearningReport(analysis);
                const evaluation = this.generateEvaluation(analysis);
                const futurePlan = this.generateFuturePlan(analysis);

                return `${learningReport}

${evaluation}

${futurePlan}`;
            }

            getCategoryName(category) {
                const categories = [
                    'ç†è§£åº¦è‰¯å¥½',
                    'åŸºç¤åŠ›å‘ä¸Šä¸­',
                    'èª²é¡Œå…‹æœä¸­',
                    'ç™ºå±•å­¦ç¿’',
                    'ç·åˆè©•ä¾¡'
                ];
                return categories[category] || 'ä¸€èˆ¬';
            }

            analyzeProgress(progressContent) {
                const analysis = {
                    subjects: [],
                    strengths: [],
                    weaknesses: [],
                    understanding: 'good',
                    attitude: 'positive',
                    specificIssues: []
                };

                // æ•™ç§‘ã®ç‰¹å®š
                if (progressContent.includes('ç®—æ•°') || progressContent.includes('æ•°å­¦')) {
                    analysis.subjects.push('ç®—æ•°ãƒ»æ•°å­¦');
                }
                if (progressContent.includes('è‹±èª')) {
                    analysis.subjects.push('è‹±èª');
                }
                if (progressContent.includes('å›½èª')) {
                    analysis.subjects.push('å›½èª');
                }
                if (progressContent.includes('ç†ç§‘')) {
                    analysis.subjects.push('ç†ç§‘');
                }
                if (progressContent.includes('ç¤¾ä¼š')) {
                    analysis.subjects.push('ç¤¾ä¼š');
                }

                // å¼·ã¿ã®ç‰¹å®š
                if (progressContent.includes('ç†è§£åº¦è‰¯å¥½') || progressContent.includes('ç†è§£åº¦è‰¯å¥½')) {
                    analysis.strengths.push('ç†è§£åŠ›');
                }
                if (progressContent.includes('ç´ æ™´ã‚‰ã—ã„') || progressContent.includes('å„ªç§€')) {
                    analysis.strengths.push('å­¦ç¿’èƒ½åŠ›');
                }
                if (progressContent.includes('ç©æ¥µçš„')) {
                    analysis.strengths.push('å­¦ç¿’æ„æ¬²');
                }

                // èª²é¡Œã®ç‰¹å®š
                if (progressContent.includes('è‹¦æ‰‹') || progressContent.includes('è‹¦æˆ¦')) {
                    analysis.weaknesses.push('ç‰¹å®šåˆ†é‡ã®ç†è§£');
                }
                if (progressContent.includes('è¨ˆç®—ãƒŸã‚¹') || progressContent.includes('ãƒŸã‚¹')) {
                    analysis.weaknesses.push('æ­£ç¢ºæ€§');
                }
                if (progressContent.includes('é…ã„') || progressContent.includes('æ™‚é–“ãŒã‹ã‹ã‚‹')) {
                    analysis.weaknesses.push('å‡¦ç†é€Ÿåº¦');
                }

                // å…·ä½“çš„ãªèª²é¡Œã®æŠ½å‡º
                if (progressContent.includes('å††å‘¨ç‡')) {
                    analysis.specificIssues.push('å††å‘¨ç‡ã®ç†è§£ã¨è¨ˆç®—');
                }
                if (progressContent.includes('å›³å½¢')) {
                    analysis.specificIssues.push('å›³å½¢å•é¡Œã®è§£æ³•');
                }
                if (progressContent.includes('ç™ºéŸ³')) {
                    analysis.specificIssues.push('è‹±èªã®ç™ºéŸ³ç·´ç¿’');
                }
                if (progressContent.includes('é †åˆ—')) {
                    analysis.specificIssues.push('é †åˆ—ã®è¨ˆç®—æ–¹æ³•');
                }
                if (progressContent.includes('å††é †åˆ—')) {
                    analysis.specificIssues.push('å††é †åˆ—ã®ç†è§£');
                }
                if (progressContent.includes('é‡è¤‡é †åˆ—')) {
                    analysis.specificIssues.push('é‡è¤‡é †åˆ—ã®è§£æ³•');
                }
                if (progressContent.includes('ç‰©è³ª') || progressContent.includes('æº¶è§£')) {
                    analysis.specificIssues.push('ç‰©è³ªã®æ€§è³ªã¨æº¶è§£');
                }
                if (progressContent.includes('æ¿ƒåº¦')) {
                    analysis.specificIssues.push('æ¿ƒåº¦è¨ˆç®—');
                }
                if (progressContent.includes('å››æ¨äº”å…¥') || progressContent.includes('æ¦‚æ•°')) {
                    analysis.specificIssues.push('å››æ¨äº”å…¥ã¨æ¦‚æ•°');
                }
                if (progressContent.includes('æ¯”') || progressContent.includes('æ–‡ç« é¡Œ')) {
                    analysis.specificIssues.push('æ¯”ã®æ–‡ç« é¡Œ');
                }
                if (progressContent.includes('ä¸‰è§’å½¢') || progressContent.includes('é¢ç©')) {
                    analysis.specificIssues.push('ä¸‰è§’å½¢ã®é¢ç©è¨ˆç®—');
                }
                if (progressContent.includes('åˆ†æ•°') || progressContent.includes('é€šåˆ†')) {
                    analysis.specificIssues.push('åˆ†æ•°ã®è¨ˆç®—');
                }
                if (progressContent.includes('è¨ˆç®—ã‚·ãƒªãƒ¼ã‚º')) {
                    analysis.specificIssues.push('è¨ˆç®—ã‚·ãƒªãƒ¼ã‚º');
                }
                if (progressContent.includes('è«–ç†ã‚¨ãƒ³ã‚¸ãƒ³') || progressContent.includes('æ¥ç¶šè©')) {
                    analysis.specificIssues.push('è«–ç†ã‚¨ãƒ³ã‚¸ãƒ³');
                }

                                 return analysis;
             }

             displayMLDataInfo() {
                 const mlData = JSON.parse(localStorage.getItem('mlTrainingData') || '[]');
                 const mlDataInfo = document.getElementById('mlDataInfo');
                 
                 if (mlData.length === 0) {
                     mlDataInfo.innerHTML = '<p style="color: #7f8c8d; text-align: center;">æ©Ÿæ¢°å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
                     return;
                 }
                 
                 const totalSamples = mlData.length;
                 const averageRating = mlData.reduce((sum, data) => sum + data.rating, 0) / totalSamples;
                 const highQualityCount = mlData.filter(data => data.rating >= 4).length;
                 const lowQualityCount = mlData.filter(data => data.rating <= 2).length;
                 
                 mlDataInfo.innerHTML = `
                     <div style="background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 10px;">
                         <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                             <span><strong>ç·ã‚µãƒ³ãƒ—ãƒ«æ•°:</strong> ${totalSamples}ä»¶</span>
                             <span><strong>å¹³å‡è©•ä¾¡:</strong> ${averageRating.toFixed(1)}/5</span>
                         </div>
                         <div style="display: flex; justify-content: space-between;">
                             <span><strong>é«˜å“è³ª:</strong> ${highQualityCount}ä»¶</span>
                             <span><strong>ä½å“è³ª:</strong> ${lowQualityCount}ä»¶</span>
                         </div>
                     </div>
                     <p style="font-size: 0.9rem; color: #7f8c8d; margin-top: 10px;">
                         â€» 10ä»¶ä»¥ä¸Šã®ãƒ‡ãƒ¼ã‚¿ã§æ©Ÿæ¢°å­¦ç¿’åˆ†æãŒå¯èƒ½ã«ãªã‚Šã¾ã™
                     </p>
                 `;
             }

            generateLearningReport(analysis) {
                const subject = analysis.subjects.length > 0 ? analysis.subjects[0] : 'å­¦ç¿’';
                const specificContent = this.extractSpecificContent(document.getElementById('progressContent').value);
                const progressContent = document.getElementById('progressContent').value;
                
                // å®Ÿéš›ã®è¬›å¸«ã®å ±å‘Šæ›¸ã‚µãƒ³ãƒ—ãƒ«ã«åŸºã¥ãå­¦ç¿’å ±å‘Š
                if (specificContent.includes('é †åˆ—')) {
                    return `æœ¬æ—¥ã¯é †åˆ—ã«ã¤ã„ã¦å­¦ã³ã¾ã—ãŸã€‚é †åˆ—ã«ã¤ã„ã¦åˆã‚ã¦å­¦ã¶ã‚ˆã†ã§ã—ãŸã®ã§ã€è¨ˆç®—æ–¹æ³•ã‚‚å«ã‚è§£ãæ–¹ã‚’è§£èª¬ã—ã¾ã—ãŸã€‚å††é †åˆ—ã¨é‡è¤‡é †åˆ—ã«ã¤ã„ã¦ã‚‚è§£èª¬ã—ã¾ã—ãŸã€‚`;
                } else if (specificContent.includes('ç‰©è³ª') || specificContent.includes('æº¶è§£')) {
                    return `ç†ç§‘ã®ç‰©è³ªã®æ€§è³ªã¨æº¶è§£ã«é–¢ã™ã‚‹å•é¡Œã®è§£èª¬ã‚’è¡Œã„ã¾ã—ãŸã€‚ç‰©è³ªã®æ€§è³ªã«ã¤ã„ã¦ï¼ˆé…¸æ€§ã‚„é‡ã•ã€æœ‰æ©Ÿç‰©ç„¡æ©Ÿç‰©ï¼‰ãªã©çŸ¥è­˜ã®é¢ã§æŠœã‘ã¦ã„ã‚‹ã¨ã“ã‚ãŒã‚ã£ãŸå°è±¡ã§ã™ã€‚æš—è¨˜é …ç›®ã«ã¤ã„ã¦è§£èª¬ã‚’åŠ ãˆãªãŒã‚‰è¦šãˆã¦ã‚‚ã‚‰ã†ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚æº¶è§£ã®æ¿ƒåº¦ã«é–¢ã™ã‚‹å•é¡Œã§ã¯ã€ãƒ“ãƒ¼ã‚«ãƒ¼ã«æ°´ã‚’åŠ ãˆãŸå¾Œãªã©çŠ¶æ…‹ãŒé·ç§»ã™ã‚‹ã¨åæ‹¾ãŒã¤ã‹ãªããªã‚Šè§£ã‘ã¦ã„ãªã„ã‚ˆã†ã§ã—ãŸã€‚ãƒ“ãƒ¼ã‚«ãƒ¼ã‚’æãã©ã†ã„ã£ãŸçŠ¶æ…‹ã«ãªã£ã¦ã‚‹ã‹ã‚ã‹ã‚‹ã‚ˆã†ã«ã—ã¦è§£ãã‚ˆã†ã«æŒ‡å°ã—ã¾ã—ãŸã€‚`;
                } else if (specificContent.includes('å††å‘¨ç‡')) {
                    return `æœ¬æ—¥ã¯å††å‘¨ç‡ã«ã¤ã„ã¦å­¦ã³ã¾ã—ãŸã€‚å††å‘¨ç‡ã®è¨ˆç®—ã«ã¤ã„ã¦åˆã‚ã¦å­¦ã¶ã‚ˆã†ã§ã—ãŸã®ã§ã€è¨ˆç®—æ–¹æ³•ã‚‚å«ã‚è§£ãæ–¹ã‚’è§£èª¬ã—ã¾ã—ãŸã€‚`;
                } else if (specificContent.includes('å››æ¨äº”å…¥') || specificContent.includes('æ¦‚æ•°')) {
                    return `å››æ¨äº”å…¥ã¨æ¦‚æ•°ã«ã¤ã„ã¦è§£ãã¾ã—ãŸã€‚åˆã‚ã¯å››æ¨äº”å…¥ã®ã‚„ã‚Šæ–¹ãŒé›£ã—ãä¸­ã€…ç†è§£ã«è‹¦ã—ã‚“ã§ã„ã¾ã—ãŸã€‚ãã®ãŸã‚ã€ã‚†ã£ãã‚Šèª¬æ˜ã—ã€å°‘ã—ã¥ã¤ç†è§£ã—ã¦ã‚‚ã‚‰ã„ã¾ã—ãŸã€‚`;
                } else if (specificContent.includes('æ¯”') || specificContent.includes('æ–‡ç« é¡Œ')) {
                    return `æ¯”ã‚’ç”¨ã„ãŸæ–‡ç« é¡Œã«ã‚ˆã‚‹å•é¡Œã‚’è§£ãã¾ã—ãŸã€‚å­¦æ ¡ã§ã®æˆæ¥­ã®è¨˜æ†¶ã‚‚æ›–æ˜§ã§ã€éå¸¸ã«é›£æ˜“åº¦ã®é«˜ã„å•é¡Œã§ã—ãŸã€‚ã‚†ã£ãã‚Šèª¬æ˜ã‚’ã—ã€ã‚ã‚‹ç¨‹åº¦è§£ãæ–¹ã‚’ç†è§£ã—ã¦è²°ãˆãŸã¨æ€ã„ã¾ã™ã€‚`;
                } else if (specificContent.includes('å›³å½¢') || specificContent.includes('ä¸‰è§’å½¢')) {
                    return `æœ¬æ—¥ã¯å®¿é¡Œã¨å¤å­£ãƒ†ã‚­ã‚¹ãƒˆã®ä¸¸ä»˜ã‘ã¨æ¼”ç¿’ã‚’è¡Œã„ã¾ã—ãŸã€‚å›³å½¢ã§ã¯ä¸‰è§’å½¢ã®é¢ç©å·¥å¤«ã—ã¦ã‚’æ±‚ã‚ã‚‹å•é¡Œã«è‹¦æˆ¦ã—ã¦ã„ã¾ã—ãŸã€‚`;
                } else if (specificContent.includes('åˆ†æ•°') || specificContent.includes('é€šåˆ†')) {
                    return `æœ¬æ—¥ã¯å®¿é¡Œã¨å¤å­£ãƒ†ã‚­ã‚¹ãƒˆã®ä¸¸ä»˜ã‘ã¨æ¼”ç¿’ã‚’è¡Œã„ã¾ã—ãŸã€‚åˆ†æ•°ã®è¨ˆç®—ã§ã¯é€šåˆ†ã‚’ã—ã¦è¶³ã—ç®—å¼•ãç®—ã‚’ã™ã‚‹éš›ã®è¨ˆç®—ãƒŸã‚¹ãŒä»Šå›ã¯å¤šãè¦‹ã‚‰ã‚Œã¾ã—ãŸã€‚`;
                } else {
                    return `æœ¬æ—¥ã¯${specificContent}ã«ã¤ã„ã¦å­¦ã³ã¾ã—ãŸã€‚${specificContent}ã«ã¤ã„ã¦åˆã‚ã¦å­¦ã¶ã‚ˆã†ã§ã—ãŸã®ã§ã€è¨ˆç®—æ–¹æ³•ã‚‚å«ã‚è§£ãæ–¹ã‚’è§£èª¬ã—ã¾ã—ãŸã€‚`;
                }
            }

            generateEvaluation(analysis) {
                const strengths = analysis.strengths;
                const weaknesses = analysis.weaknesses;
                const specificIssues = analysis.specificIssues;
                const progressContent = document.getElementById('progressContent').value;
                const subject = analysis.subjects.length > 0 ? analysis.subjects[0] : 'å­¦ç¿’';

                let evaluation = 'ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆç”Ÿå¾’ãƒ»ä¿è­·è€…ã«å…¬é–‹ã•ã‚Œã¾ã™ï¼‰\n';

                // å®Ÿéš›ã®è¬›å¸«ã®å ±å‘Šæ›¸ã‚µãƒ³ãƒ—ãƒ«ã«åŸºã¥ãè©•ä¾¡
                if (subject === 'ç®—æ•°ãƒ»æ•°å­¦' && progressContent.includes('é †åˆ—')) {
                    evaluation += 'ç†è§£ãŒã¨ã¦ã‚‚æ—©ãã€å¤§æŠµã®å•é¡ŒãŒé–“é•ã£ã¦ã„ã¦ã‚‚ã™ãã«æ­£ã—ã„ç­”ãˆã‚’å°ãå‡ºã—ã¦ã„ã¦ã™ã°ã‚‰ã—ã‹ã£ãŸã§ã™ã€‚ã—ã£ã‹ã‚Šã¨ä¸¦ã¹æ–¹ã®è€ƒãˆæ–¹ã€è¨ˆç®—ãŒèº«ã«ã¤ã„ã¦ã„ã‚‹ã¨æ„Ÿã˜ã¾ã—ãŸã€‚';
                    evaluation += '\n\nå††é †åˆ—ã¯å•é¡Œãªãç†è§£ã§ãã¦ã„ã¾ã—ãŸã€‚';
                    evaluation += '\n\né‡è¤‡é †åˆ—ã‚‚ç†è§£ã§ãã¦ã„ã¾ã—ãŸãŒã€å•é¡Œã‚’è§£ãã®ã«å°‘ã—è‹¦æˆ¦ã—ã¦ã„ã¾ã—ãŸã€‚ä½•ã‚’ä¸¦ã¹ã‚‹ã‹ã®å¯¾å¿œé–¢ä¿‚ã‚’æŠŠæ¡ã™ã‚‹ã“ã¨ãŒå¤§äº‹ã§ã™ã€‚';
                    evaluation += '\n\nå…¨ä½“ã¨ã—ã¦ã€ã¾ã ä¾‹å¤–ã‚’é™¤ãå ´åˆã¨ç‰¹æ®ŠãªçŠ¶æ³ã‚’å€‹åˆ¥ã§è€ƒãˆã¦è¨ˆç®—ã™ã‚‹ã“ã¨ãŒå®Œå…¨ã«ã§ãã¦ã„ãªã„ã¨æ„Ÿã˜ã¾ã—ãŸã€‚å®¿é¡Œã‚’é€šã˜ã¦è¦‹æ¥µã‚ã‚‰ã‚Œã‚‹ã‚ˆã†ã«é ‘å¼µã‚Šã¾ã—ã‚‡ã†ã€‚';
                } else if (subject === 'ç†ç§‘' && (progressContent.includes('ç‰©è³ª') || progressContent.includes('æº¶è§£'))) {
                    evaluation += 'ç‰©è³ªã®æ€§è³ªã«ã¤ã„ã¦ï¼ˆé…¸æ€§ã‚„é‡ã•ã€æœ‰æ©Ÿç‰©ç„¡æ©Ÿç‰©ï¼‰ãªã©çŸ¥è­˜ã®é¢ã§æŠœã‘ã¦ã„ã‚‹ã¨ã“ã‚ãŒã‚ã£ãŸå°è±¡ã§ã™ã€‚æš—è¨˜é …ç›®ã«ã¤ã„ã¦è§£èª¬ã‚’åŠ ãˆãªãŒã‚‰è¦šãˆã¦ã‚‚ã‚‰ã†ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚';
                    evaluation += '\n\næº¶è§£ã®æ¿ƒåº¦ã«é–¢ã™ã‚‹å•é¡Œã§ã¯ã€ãƒ“ãƒ¼ã‚«ãƒ¼ã«æ°´ã‚’åŠ ãˆãŸå¾Œãªã©çŠ¶æ…‹ãŒé·ç§»ã™ã‚‹ã¨åæ‹¾ãŒã¤ã‹ãªããªã‚Šè§£ã‘ã¦ã„ãªã„ã‚ˆã†ã§ã—ãŸã€‚ãƒ“ãƒ¼ã‚«ãƒ¼ã‚’æãã©ã†ã„ã£ãŸçŠ¶æ…‹ã«ãªã£ã¦ã‚‹ã‹ã‚ã‹ã‚‹ã‚ˆã†ã«ã—ã¦è§£ãã‚ˆã†ã«æŒ‡å°ã—ã¾ã—ãŸã€‚';
                } else if (progressContent.includes('å††å‘¨ç‡')) {
                    evaluation += 'å††å‘¨ç‡ã®è¨ˆç®—ã«ã¤ã„ã¦ç†è§£ãŒã¨ã¦ã‚‚æ—©ãã€å¤§æŠµã®å•é¡ŒãŒé–“é•ã£ã¦ã„ã¦ã‚‚ã™ãã«æ­£ã—ã„ç­”ãˆã‚’å°ãå‡ºã—ã¦ã„ã¦ã™ã°ã‚‰ã—ã‹ã£ãŸã§ã™ã€‚ã—ã£ã‹ã‚Šã¨è¨ˆç®—æ–¹æ³•ãŒèº«ã«ã¤ã„ã¦ã„ã‚‹ã¨æ„Ÿã˜ã¾ã—ãŸã€‚';
                    evaluation += '\n\nå††å‘¨ç‡ã®ç†è§£ã¨è¨ˆç®—ã«ã¤ã„ã¦ã¯å•é¡Œãªãç†è§£ã§ãã¦ã„ã¾ã—ãŸãŒã€è¨ˆç®—ã®æ­£ç¢ºæ€§ã®é¢ã§å°‘ã—è‹¦æˆ¦ã—ã¦ã„ã¾ã—ãŸã€‚ä½•ã‚’è¨ˆç®—ã™ã‚‹ã‹ã®å¯¾å¿œé–¢ä¿‚ã‚’æŠŠæ¡ã™ã‚‹ã“ã¨ãŒå¤§äº‹ã§ã™ã€‚';
                } else if (progressContent.includes('å››æ¨äº”å…¥') || progressContent.includes('æ¦‚æ•°')) {
                    evaluation += '1åº¦ç†è§£ã—ã¦è²°ã£ã¦ã‹ã‚‰ã¯æ²¢å±±ç·´ç¿’ã‚’ã—ã€å››æ¨äº”å…¥ã®ã‚„ã‚Šæ–¹ã‚’å®Œç’§ã«å®šç€ã—ã¦ã‚‚ã‚‰ã„ã¾ã—ãŸã€‚';
                    evaluation += '\n\nã¾ãŸã€è§’åº¦ã«ã¤ã„ã¦ã®å•é¡Œã‚‚è§£ãã¾ã—ãŸã€‚ã“ã¡ã‚‰ã¯æ–°ã—ãçŸ¥ã‚‹ç”¨èªãŒã‚ã£ãŸã®ã§ã€ãã‚Œã‚’èª¬æ˜ã‚’ã—ã€ç†è§£ã—ã¦ã€ãŸãã•ã‚“å•é¡Œã‚’è§£ã„ã¦ã‚‚ã‚‰ã„ã¾ã—ãŸã€‚';
                } else if (progressContent.includes('æ¯”') || progressContent.includes('æ–‡ç« é¡Œ')) {
                    evaluation += 'ç´ æ™´ã‚‰ã—ã„ã§ã™ã€‚';
                    evaluation += '\n\nã—ã‹ã—è‡ªåŠ›ã§æ­£è§£ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã¾ã§å®šç€ã•ã›ã‚‹ãŸã‚ã«ã¯ã€å¾©ç¿’ã‚’é‡ã­ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã®ã§ã€ä»Šæ—¥ã®æˆæ¥­å†…å®¹ã‚’ãŠã•ã‚‰ã„ã—ã¦ãŠã„ã¦ãã ã•ã„ã€‚';
                } else if (progressContent.includes('å›³å½¢') || progressContent.includes('ä¸‰è§’å½¢')) {
                    evaluation += 'åº•è¾ºã¨é«˜ã•ã®å ´æ‰€ãŒãšã‚Œã¦ã„ã‚‹ã¨ã€ã©ã“ãŒåº•è¾ºã‚„é«˜ã•ãªã®ã‹ã‚ã‹ã‚‰ãšè§£ãæ–¹ãŒåˆ†ã‹ã‚‰ãªããªã£ã¦ã—ã¾ã£ã¦ã„ã‚‹ã‚ˆã†ã§ã—ãŸã€‚';
                } else if (progressContent.includes('åˆ†æ•°') || progressContent.includes('é€šåˆ†')) {
                    evaluation += 'è½ã¡ç€ã„ã¦è¨ˆç®—ã™ã‚Œã°ã§ãã‚‹ã¨æ€ã†ã®ã§é›†ä¸­ã—ã¦è§£ãã¾ã—ã‚‡ã†ã€‚';
                } else if (progressContent.includes('è¨ˆç®—ã‚·ãƒªãƒ¼ã‚º') || progressContent.includes('æ–‡ç« é¡Œ')) {
                    evaluation += 'è¨ˆç®—ã‚·ãƒªãƒ¼ã‚ºã§ã¯æ–‡ç« é¡Œã®å•é¡Œã§ä»Šã¾ã§ã«ç¿’ã£ãŸå•é¡Œã®å°‘ã—é›£ã—ã‚ã®å•é¡Œã§è‹¦æˆ¦ã—ã¦ã„ã¾ã—ãŸã€‚ã©ã†ã„ã†è§£ãæ–¹ã‚’ã™ã‚‹ã®ã‹æ€ã„å‡ºã—ã¦å¾©ç¿’ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã—ã‚‡ã†ã€‚';
                    evaluation += '\n\næ–°å°å­¦å•é¡Œé›†ã¯ã€AãŒï¼¢ã®ä½•å€ã‹ã¨ã„ã†å•é¡Œã§åˆ†æ¯åˆ†å­ã‚’é€†ã«ã—ã¦ã„ãŸãŸã‚æ°—ã‚’ã‚‹ã‘ã‚‹ã‚ˆã†ã«ã—ã¾ã—ã‚‡ã†ã€‚è¨ˆç®—å•é¡Œã¯ã‚ˆãã§ãã¦ã„ã¾ã—ãŸã€‚';
                } else if (progressContent.includes('è«–ç†ã‚¨ãƒ³ã‚¸ãƒ³') || progressContent.includes('æ¥ç¶šè©')) {
                    evaluation += 'è«–ç†ã‚¨ãƒ³ã‚¸ãƒ³ã¯ã€"ã ã‹ã‚‰"ã—ã‹ã—"ãªã©ã®æ¥ç¶šè©ã‹ã‚‰æ–‡ç« ã®å‰å¾Œã®é–¢ä¿‚ã‚’è€ƒãˆãŸã‚Šã€ç­†è€…ã®ä¸»å¼µã®å¼·èª¿è¡¨ç¾ãªã©ã®é‡è¦ãªå ´æ‰€ã«æ„è­˜ã‚’ã‚€ã‘ã‚‹ã‚ˆã†ã«ã™ã‚‹ã¨ã€ã‚ˆã‚Šã‚ˆãæ–‡ç« ã®æœ¬è³ªã‚’ã¤ã‹ã‚ã‚‹ã‚ˆã†ã«ãªã‚‹ã¨æ€ã„ã¾ã™ã€‚';
                } else {
                    // ä¸€èˆ¬çš„ãªè©•ä¾¡
                    if (strengths.includes('ç†è§£åŠ›')) {
                        evaluation += 'ç†è§£ãŒã¨ã¦ã‚‚æ—©ãã€å¤§æŠµã®å•é¡ŒãŒé–“é•ã£ã¦ã„ã¦ã‚‚ã™ãã«æ­£ã—ã„ç­”ãˆã‚’å°ãå‡ºã—ã¦ã„ã¦ã™ã°ã‚‰ã—ã‹ã£ãŸã§ã™ã€‚ã—ã£ã‹ã‚Šã¨ä¸¦ã¹æ–¹ã®è€ƒãˆæ–¹ã€è¨ˆç®—ãŒèº«ã«ã¤ã„ã¦ã„ã‚‹ã¨æ„Ÿã˜ã¾ã—ãŸã€‚';
                    } else if (strengths.includes('å­¦ç¿’èƒ½åŠ›')) {
                        evaluation += 'å­¦ç¿’èƒ½åŠ›ãŒé«˜ãã€è¤‡é›‘ãªå•é¡Œã«ã‚‚å¯¾å¿œã§ãã‚‹åŠ›ã‚’æŒã£ã¦ã„ã¾ã™ã€‚å¤§æŠµã®å•é¡ŒãŒã—ã£ã‹ã‚Šã¨èº«ã«ã¤ã„ã¦ã„ã‚‹ã¨æ„Ÿã˜ã¾ã—ãŸã€‚';
                    } else if (strengths.includes('å­¦ç¿’æ„æ¬²')) {
                        evaluation += 'å­¦ç¿’ã«å¯¾ã™ã‚‹æ„æ¬²ãŒé«˜ãã€ç©æ¥µçš„ã«å–ã‚Šçµ„ã‚€å§¿å‹¢ãŒç´ æ™´ã‚‰ã—ã„ã§ã™ã€‚æ–°ã—ã„å†…å®¹ã¸ã®å¥½å¥‡å¿ƒãŒå¼·ãã€ç†è§£ã‚’æ·±ã‚ã‚ˆã†ã¨ã™ã‚‹æ…‹åº¦ãŒå°è±¡çš„ã§ã—ãŸã€‚';
                    } else {
                        evaluation += 'å­¦ç¿’æ…‹åº¦ã¯è‰¯å¥½ã§ã€ç€å®Ÿã«åŠ›ã‚’ã¤ã‘ã¦ã„ã¾ã™ã€‚ä¸€ã¤ã²ã¨ã¤ã®å•é¡Œã«çœŸå‰£ã«å‘ãåˆã„ã€ç†è§£ã‚’æ·±ã‚ã‚ˆã†ã¨ã™ã‚‹å§¿å‹¢ãŒè¦‹ã‚‰ã‚Œã¾ã—ãŸã€‚';
                    }

                    if (specificIssues.length > 0) {
                        evaluation += `\n\n${specificIssues[0]}ã¯å•é¡Œãªãç†è§£ã§ãã¦ã„ã¾ã—ãŸã€‚`;
                        
                        if (weaknesses.includes('æ­£ç¢ºæ€§')) {
                            evaluation += '\n\nè¨ˆç®—ã®æ­£ç¢ºæ€§ã®é¢ã§å°‘ã—è‹¦æˆ¦ã—ã¦ã„ã¾ã—ãŸã€‚ä½•ã‚’è¨ˆç®—ã™ã‚‹ã‹ã®å¯¾å¿œé–¢ä¿‚ã‚’æŠŠæ¡ã™ã‚‹ã“ã¨ãŒå¤§äº‹ã§ã™ã€‚';
                        } else if (weaknesses.includes('ç‰¹å®šåˆ†é‡ã®ç†è§£')) {
                            evaluation += '\n\nå¿œç”¨å•é¡Œã®è§£æ³•ã«å°‘ã—è‹¦æˆ¦ã—ã¦ã„ã¾ã—ãŸã€‚ä½•ã‚’ä¸¦ã¹ã‚‹ã‹ã®å¯¾å¿œé–¢ä¿‚ã‚’æŠŠæ¡ã™ã‚‹ã“ã¨ãŒå¤§äº‹ã§ã™ã€‚';
                        } else if (weaknesses.includes('å‡¦ç†é€Ÿåº¦')) {
                            evaluation += '\n\nå•é¡Œè§£æ±ºã®ã‚¹ãƒ”ãƒ¼ãƒ‰ã®é¢ã§å°‘ã—æ™‚é–“ãŒã‹ã‹ã£ã¦ã„ã¾ã—ãŸã€‚';
                        } else {
                            evaluation += '\n\nã‚ˆã‚Šé«˜åº¦ãªå†…å®¹ã®ç†è§£ã«å°‘ã—æ™‚é–“ãŒã‹ã‹ã£ã¦ã„ã¾ã—ãŸã€‚';
                        }
                    }

                    if (weaknesses.length > 0) {
                        evaluation += '\n\nå…¨ä½“ã¨ã—ã¦ã€ã¾ã ä¾‹å¤–ã‚’é™¤ãå ´åˆã¨ç‰¹æ®ŠãªçŠ¶æ³ã‚’å€‹åˆ¥ã§è€ƒãˆã¦è¨ˆç®—ã™ã‚‹ã“ã¨ãŒå®Œå…¨ã«ã§ãã¦ã„ãªã„ã¨æ„Ÿã˜ã¾ã—ãŸã€‚å®¿é¡Œã‚’é€šã˜ã¦è¦‹æ¥µã‚ã‚‰ã‚Œã‚‹ã‚ˆã†ã«é ‘å¼µã‚Šã¾ã—ã‚‡ã†ã€‚';
                    }
                }

                return evaluation;
            }

            generateFuturePlan(analysis) {
                const weaknesses = analysis.weaknesses;
                const specificIssues = analysis.specificIssues;
                const subject = analysis.subjects.length > 0 ? analysis.subjects[0] : 'å­¦ç¿’';
                const progressContent = document.getElementById('progressContent').value;

                let plan = '';

                // å®Ÿéš›ã®è¬›å¸«ã®å ±å‘Šæ›¸ã‚µãƒ³ãƒ—ãƒ«ã«åŸºã¥ãä»Šå¾Œã®æ–¹é‡
                if (subject === 'ç®—æ•°ãƒ»æ•°å­¦' && progressContent.includes('é †åˆ—')) {
                    plan += 'é †åˆ—ã®è¨ˆç®—æ–¹æ³•ã«ã¤ã„ã¦ã€å…·ä½“çš„ãªç·´ç¿’å•é¡Œã‚’é€šã˜ã¦ç†è§£ã‚’æ·±ã‚ã¦ã„ãã¾ã™ã€‚ç‰¹ã«ã€å††é †åˆ—ã¨é‡è¤‡é †åˆ—ã®é•ã„ã‚’ã—ã£ã‹ã‚Šã¨ç†è§£ã—ã€ãã‚Œãã‚Œã®è¨ˆç®—æ–¹æ³•ã‚’ç¢ºå®Ÿã«ãƒã‚¹ã‚¿ãƒ¼ã§ãã‚‹ã‚ˆã†ã‚µãƒãƒ¼ãƒˆã„ãŸã—ã¾ã™ã€‚';
                    plan += '\n\nä¾‹å¤–ã‚’é™¤ãå ´åˆã¨ç‰¹æ®ŠãªçŠ¶æ³ã‚’å€‹åˆ¥ã§è€ƒãˆã¦è¨ˆç®—ã™ã‚‹ç·´ç¿’ã‚’é‡ã­ã€å®¿é¡Œã‚’é€šã˜ã¦è¦‹æ¥µã‚ã‚‰ã‚Œã‚‹ã‚ˆã†ã«é ‘å¼µã‚Šã¾ã—ã‚‡ã†ã€‚';
                } else if (subject === 'ç†ç§‘' && (progressContent.includes('ç‰©è³ª') || progressContent.includes('æº¶è§£'))) {
                    plan += 'ç‰©è³ªã®æ€§è³ªã«ã¤ã„ã¦ï¼ˆé…¸æ€§ã‚„é‡ã•ã€æœ‰æ©Ÿç‰©ç„¡æ©Ÿç‰©ï¼‰ãªã©çŸ¥è­˜ã®é¢ã§æŠœã‘ã¦ã„ã‚‹ã¨ã“ã‚ãŒã‚ã£ãŸå°è±¡ã§ã™ã€‚æš—è¨˜é …ç›®ã«ã¤ã„ã¦è§£èª¬ã‚’åŠ ãˆãªãŒã‚‰è¦šãˆã¦ã‚‚ã‚‰ã†ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚';
                    plan += '\n\næº¶è§£ã®æ¿ƒåº¦ã«é–¢ã™ã‚‹å•é¡Œã§ã¯ã€ãƒ“ãƒ¼ã‚«ãƒ¼ã«æ°´ã‚’åŠ ãˆãŸå¾Œãªã©çŠ¶æ…‹ãŒé·ç§»ã™ã‚‹ã¨åæ‹¾ãŒã¤ã‹ãªããªã‚Šè§£ã‘ã¦ã„ãªã„ã‚ˆã†ã§ã—ãŸã€‚ãƒ“ãƒ¼ã‚«ãƒ¼ã‚’æãã©ã†ã„ã£ãŸçŠ¶æ…‹ã«ãªã£ã¦ã‚‹ã‹ã‚ã‹ã‚‹ã‚ˆã†ã«ã—ã¦è§£ãã‚ˆã†ã«æŒ‡å°ã—ã¾ã—ãŸã€‚';
                } else if (progressContent.includes('å††å‘¨ç‡')) {
                    plan += 'å††å‘¨ç‡ã®è¨ˆç®—ã«ã¤ã„ã¦ã€å…·ä½“çš„ãªç·´ç¿’å•é¡Œã‚’é€šã˜ã¦ç†è§£ã‚’æ·±ã‚ã¦ã„ãã¾ã™ã€‚è¨ˆç®—ã®æ­£ç¢ºæ€§ã‚’å‘ä¸Šã•ã›ã‚‹ãŸã‚ã€è¨ˆç®—éç¨‹ã‚’ä¸å¯§ã«ç¢ºèªã™ã‚‹ç¿’æ…£ã‚’èº«ã«ã¤ã‘ã‚‹ã“ã¨ã§ã€æ­£ç¢ºæ€§ã®å‘ä¸ŠãŒæœŸå¾…ã§ãã¾ã™ã€‚';
                    plan += '\n\nä½•ã‚’è¨ˆç®—ã™ã‚‹ã‹ã®å¯¾å¿œé–¢ä¿‚ã‚’æŠŠæ¡ã™ã‚‹ç·´ç¿’ã‚’é‡ã­ã€ç¢ºå®Ÿã«ãƒã‚¹ã‚¿ãƒ¼ã§ãã‚‹ã‚ˆã†ã‚µãƒãƒ¼ãƒˆã„ãŸã—ã¾ã™ã€‚';
                } else if (progressContent.includes('å››æ¨äº”å…¥') || progressContent.includes('æ¦‚æ•°')) {
                    plan += 'ã©ã¡ã‚‰ã®åˆ†é‡ã«ã‚‚å…±é€šã™ã‚‹ã“ã¨ã¨ã—ã¦ã€å¿˜ã‚Œãªã„ãŸã‚ã«ã€ã—ã£ã‹ã‚Šå¾©ç¿’ã‚’ã—ã¦ã»ã—ã„ã¨æ€ã„ã¾ã™ã€‚';
                } else if (progressContent.includes('æ¯”') || progressContent.includes('æ–‡ç« é¡Œ')) {
                    plan += 'ã—ã‹ã—è‡ªåŠ›ã§æ­£è§£ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã¾ã§å®šç€ã•ã›ã‚‹ãŸã‚ã«ã¯ã€å¾©ç¿’ã‚’é‡ã­ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã®ã§ã€ä»Šæ—¥ã®æˆæ¥­å†…å®¹ã‚’ãŠã•ã‚‰ã„ã—ã¦ãŠã„ã¦ãã ã•ã„ã€‚';
                } else if (progressContent.includes('å›³å½¢') || progressContent.includes('ä¸‰è§’å½¢')) {
                    plan += 'åº•è¾ºã¨é«˜ã•ã®å ´æ‰€ãŒãšã‚Œã¦ã„ã‚‹ã¨ã€ã©ã“ãŒåº•è¾ºã‚„é«˜ã•ãªã®ã‹ã‚ã‹ã‚‰ãšè§£ãæ–¹ãŒåˆ†ã‹ã‚‰ãªããªã£ã¦ã—ã¾ã£ã¦ã„ã‚‹ã‚ˆã†ã§ã—ãŸã€‚';
                } else if (progressContent.includes('åˆ†æ•°') || progressContent.includes('é€šåˆ†')) {
                    plan += 'è½ã¡ç€ã„ã¦è¨ˆç®—ã™ã‚Œã°ã§ãã‚‹ã¨æ€ã†ã®ã§é›†ä¸­ã—ã¦è§£ãã¾ã—ã‚‡ã†ã€‚';
                } else if (progressContent.includes('è¨ˆç®—ã‚·ãƒªãƒ¼ã‚º') || progressContent.includes('æ–‡ç« é¡Œ')) {
                    plan += 'ã©ã†ã„ã†è§£ãæ–¹ã‚’ã™ã‚‹ã®ã‹æ€ã„å‡ºã—ã¦å¾©ç¿’ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã—ã‚‡ã†ã€‚';
                } else if (progressContent.includes('è«–ç†ã‚¨ãƒ³ã‚¸ãƒ³') || progressContent.includes('æ¥ç¶šè©')) {
                    plan += 'è«–ç†ã‚¨ãƒ³ã‚¸ãƒ³ã¯ã€"ã ã‹ã‚‰"ã—ã‹ã—"ãªã©ã®æ¥ç¶šè©ã‹ã‚‰æ–‡ç« ã®å‰å¾Œã®é–¢ä¿‚ã‚’è€ƒãˆãŸã‚Šã€ç­†è€…ã®ä¸»å¼µã®å¼·èª¿è¡¨ç¾ãªã©ã®é‡è¦ãªå ´æ‰€ã«æ„è­˜ã‚’ã‚€ã‘ã‚‹ã‚ˆã†ã«ã™ã‚‹ã¨ã€ã‚ˆã‚Šã‚ˆãæ–‡ç« ã®æœ¬è³ªã‚’ã¤ã‹ã‚ã‚‹ã‚ˆã†ã«ãªã‚‹ã¨æ€ã„ã¾ã™ã€‚';
                } else {
                    // ä¸€èˆ¬çš„ãªä»Šå¾Œã®æ–¹é‡
                    if (weaknesses.includes('æ­£ç¢ºæ€§')) {
                        plan += 'è¨ˆç®—ãƒŸã‚¹ã‚’æ¸›ã‚‰ã™ãŸã‚ã€åŸºç¤è¨ˆç®—ã®åå¾©ç·´ç¿’ã‚’ç¶™ç¶šã„ãŸã—ã¾ã™ã€‚ç‰¹ã«ã€è¨ˆç®—éç¨‹ã‚’ä¸å¯§ã«ç¢ºèªã™ã‚‹ç¿’æ…£ã‚’èº«ã«ã¤ã‘ã‚‹ã“ã¨ã§ã€æ­£ç¢ºæ€§ã®å‘ä¸ŠãŒæœŸå¾…ã§ãã¾ã™ã€‚';
                    } else if (weaknesses.includes('ç‰¹å®šåˆ†é‡ã®ç†è§£')) {
                        plan += 'è‹¦æ‰‹åˆ†é‡ã®å…‹æœã®ãŸã‚ã€æ®µéšçš„ãªå­¦ç¿’ã‚’é€²ã‚ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚åŸºç¤ã‹ã‚‰å¿œç”¨ã¾ã§ã€ç†è§£åº¦ã«å¿œã˜ãŸé©åˆ‡ãªãƒ¬ãƒ™ãƒ«ã®å•é¡Œã«å–ã‚Šçµ„ã‚€ã“ã¨ã§ã€ç¢ºå®Ÿã«åŠ›ã‚’ã¤ã‘ã¦ã„ã‘ã¾ã™ã€‚';
                    } else if (weaknesses.includes('å‡¦ç†é€Ÿåº¦')) {
                        plan += 'å•é¡Œè§£æ±ºã®åŠ¹ç‡æ€§ã‚’å‘ä¸Šã•ã›ã‚‹ãŸã‚ã€è§£æ³•ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ç¿’å¾—ã‚’é‡è¦–ã—ã¾ã™ã€‚æ§˜ã€…ãªå•é¡Œã«è§¦ã‚Œã‚‹ã“ã¨ã§ã€è§£æ³•ã®é¸æŠè‚¢ã‚’å¢—ã‚„ã—ã€ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚¢ãƒƒãƒ—ã‚’å›³ã‚Šã¾ã™ã€‚';
                    } else {
                        plan += 'ç¾åœ¨ã®å­¦ç¿’ãƒšãƒ¼ã‚¹ã‚’ç¶­æŒã—ãªãŒã‚‰ã€ã•ã‚‰ã«ç™ºå±•çš„ãªå†…å®¹ã«ã‚‚æŒ‘æˆ¦ã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚åŸºç¤åŠ›ãŒã—ã£ã‹ã‚Šã¨èº«ã«ã¤ã„ã¦ã„ã‚‹ãŸã‚ã€å¿œç”¨åŠ›ã®å‘ä¸ŠãŒæœŸå¾…ã§ãã¾ã™ã€‚';
                    }

                    if (specificIssues.length > 0) {
                        plan += `\n\n${specificIssues[0]}ã«ã¤ã„ã¦ã¯ã€å…·ä½“çš„ãªç·´ç¿’å•é¡Œã‚’é€šã˜ã¦ç†è§£ã‚’æ·±ã‚ã¦ã„ãã¾ã™ã€‚æ®µéšçš„ã«é›£æ˜“åº¦ã‚’ä¸Šã’ãªãŒã‚‰ã€ç¢ºå®Ÿã«ãƒã‚¹ã‚¿ãƒ¼ã§ãã‚‹ã‚ˆã†ã‚µãƒãƒ¼ãƒˆã„ãŸã—ã¾ã™ã€‚`;
                    }
                }

                return plan;
            }

            generateMockReport(progressContent) {
                const analysis = this.analyzeProgress(progressContent);
                const learningReport = this.generateLearningReport(analysis);
                const evaluation = this.generateEvaluation(analysis);
                const futurePlan = this.generateFuturePlan(analysis);

                return `${learningReport}

${evaluation}

${futurePlan}`;
            }

            extractSpecificContent(progressContent) {
                if (progressContent.includes('æ•™ç§‘æ›¸p.')) {
                    const match = progressContent.match(/æ•™ç§‘æ›¸p\.(\d+)-(\d+)/);
                    if (match) {
                        return `æ•™ç§‘æ›¸${match[1]}ãƒšãƒ¼ã‚¸ã‹ã‚‰${match[2]}ãƒšãƒ¼ã‚¸`;
                    }
                }
                
                const specificTerms = [
                    'å††å‘¨ç‡', 'å›³å½¢å•é¡Œ', 'å˜èªãƒ†ã‚¹ãƒˆ', 'ç™ºéŸ³ç·´ç¿’', 'è¨ˆç®—å•é¡Œ',
                    'é †åˆ—', 'å††é †åˆ—', 'é‡è¤‡é †åˆ—', 'ç‰©è³ªã®æ€§è³ª', 'æº¶è§£', 'æ¿ƒåº¦',
                    'å››æ¨äº”å…¥', 'æ¦‚æ•°', 'æ¯”', 'æ–‡ç« é¡Œ', 'ä¸‰è§’å½¢', 'é¢ç©',
                    'åˆ†æ•°', 'é€šåˆ†', 'è¨ˆç®—ã‚·ãƒªãƒ¼ã‚º', 'è«–ç†ã‚¨ãƒ³ã‚¸ãƒ³', 'æ¥ç¶šè©'
                ];
                for (const term of specificTerms) {
                    if (progressContent.includes(term)) {
                        return term;
                    }
                }

                return progressContent;
            }

            getSubjectSpecificComment(subject) {
                const comments = {
                    'ç®—æ•°ãƒ»æ•°å­¦': 'è«–ç†çš„æ€è€ƒåŠ›ã‚’é¤Šã†é‡è¦ãªå†…å®¹ã§ã™ã€‚',
                    'è‹±èª': 'ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³èƒ½åŠ›ã®åŸºç¤ã¨ãªã‚‹å†…å®¹ã§ã™ã€‚',
                    'å›½èª': 'è¨€èªèƒ½åŠ›ã¨è¡¨ç¾åŠ›ã‚’é«˜ã‚ã‚‹å†…å®¹ã§ã™ã€‚',
                    'ç†ç§‘': 'ç§‘å­¦çš„æ€è€ƒåŠ›ã‚’è‚²ã‚€å†…å®¹ã§ã™ã€‚',
                    'ç¤¾ä¼š': 'ç¤¾ä¼šèªè­˜ã‚’æ·±ã‚ã‚‹å†…å®¹ã§ã™ã€‚'
                };

                return comments[subject] || 'åŸºç¤å­¦åŠ›ã‚’å‘ä¸Šã•ã›ã‚‹é‡è¦ãªå†…å®¹ã§ã™ã€‚';
            }

            displayResult(report, analysis, confidence) {
                document.getElementById('resultContent').textContent = report;
                
                // AIåˆ†æçµæœã‚’è¡¨ç¤º
                const analysisResult = document.getElementById('analysisResult');
                analysisResult.innerHTML = `
                    <strong>æ•™ç§‘:</strong> ${analysis.subjects.join(', ') || 'æœªç‰¹å®š'}<br>
                    <strong>å¼·ã¿:</strong> ${analysis.strengths.join(', ') || 'ãªã—'}<br>
                    <strong>èª²é¡Œ:</strong> ${analysis.weaknesses.join(', ') || 'ãªã—'}<br>
                    <strong>å…·ä½“çš„èª²é¡Œ:</strong> ${analysis.specificIssues.join(', ') || 'ãªã—'}
                `;

                // ä¿¡é ¼åº¦ãƒãƒ¼ã‚’æ›´æ–°
                const confidenceFill = document.getElementById('confidenceFill');
                const confidenceText = document.getElementById('confidenceText');
                const confidencePercent = (confidence * 100).toFixed(1);
                
                confidenceFill.style.width = `${confidencePercent}%`;
                confidenceText.textContent = `ä¿¡é ¼åº¦: ${confidencePercent}%`;

                document.getElementById('resultArea').classList.add('show');
                document.getElementById('resultArea').scrollIntoView({ behavior: 'smooth' });
            }

            addToHistory(input, output) {
                const historyItem = {
                    id: Date.now(),
                    date: new Date().toLocaleString('ja-JP'),
                    input: input.substring(0, 100) + (input.length > 100 ? '...' : ''),
                    output: output
                };

                this.history.unshift(historyItem);
                this.history = this.history.slice(0, 5);
                
                localStorage.setItem('reportHistory', JSON.stringify(this.history));
                                 this.displayHistory();
                 this.displayMLDataInfo();
             }

            displayHistory() {
                const historyList = document.getElementById('historyList');
                historyList.innerHTML = '';

                if (this.history.length === 0) {
                    historyList.innerHTML = '<p style="color: #7f8c8d; text-align: center;">ç”Ÿæˆå±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
                    return;
                }

                this.history.forEach(item => {
                    const historyItem = document.createElement('div');
                    historyItem.className = 'history-item';
                    historyItem.innerHTML = `
                        <div class="history-date">${item.date}</div>
                        <div class="history-input">${this.escapeHtml(item.input)}</div>
                    `;
                    
                    historyItem.addEventListener('click', () => {
                        document.getElementById('progressContent').value = item.input.replace('...', '');
                        document.getElementById('resultContent').textContent = item.output;
                        document.getElementById('resultArea').classList.add('show');
                    });
                    
                    historyList.appendChild(historyItem);
                });
            }

            async copyToClipboard() {
                const resultContent = document.getElementById('resultContent').textContent;
                
                try {
                    await navigator.clipboard.writeText(resultContent);
                    this.showSuccess('å ±å‘Šæ›¸ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚');
                } catch (error) {
                    const textArea = document.createElement('textarea');
                    textArea.value = resultContent;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    this.showSuccess('å ±å‘Šæ›¸ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚');
                }
            }

            sendFeedback() {
                // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ç”¨ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ä½œæˆ
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 1000;
                `;
                
                const modalContent = document.createElement('div');
                modalContent.style.cssText = `
                    background: white;
                    padding: 30px;
                    border-radius: 15px;
                    max-width: 500px;
                    width: 90%;
                    max-height: 80vh;
                    overflow-y: auto;
                `;
                
                const currentReport = document.getElementById('resultContent').textContent;
                const currentInput = document.getElementById('progressContent').value;
                
                modalContent.innerHTML = `
                    <h3 style="margin-bottom: 20px; color: #2c3e50;">ğŸ¤– æ©Ÿæ¢°å­¦ç¿’ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</h3>
                    <p style="margin-bottom: 15px; color: #7f8c8d; font-size: 0.9rem;">
                        ã“ã®å ±å‘Šæ›¸ã®å“è³ªã‚’è©•ä¾¡ã—ã¦ã€æ©Ÿæ¢°å­¦ç¿’ãƒ¢ãƒ‡ãƒ«ã®æ”¹å–„ã«ã”å”åŠ›ãã ã•ã„ã€‚
                    </p>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50;">
                            å ±å‘Šæ›¸ã®å“è³ªè©•ä¾¡
                        </label>
                        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                            <button class="rating-btn" data-rating="1" style="padding: 8px 12px; border: 2px solid #e1e8ed; border-radius: 5px; background: white; cursor: pointer;">1 (ä½)</button>
                            <button class="rating-btn" data-rating="2" style="padding: 8px 12px; border: 2px solid #e1e8ed; border-radius: 5px; background: white; cursor: pointer;">2</button>
                            <button class="rating-btn" data-rating="3" style="padding: 8px 12px; border: 2px solid #e1e8ed; border-radius: 5px; background: white; cursor: pointer;">3 (æ™®é€š)</button>
                            <button class="rating-btn" data-rating="4" style="padding: 8px 12px; border: 2px solid #e1e8ed; border-radius: 5px; background: white; cursor: pointer;">4</button>
                            <button class="rating-btn" data-rating="5" style="padding: 8px 12px; border: 2px solid #e1e8ed; border-radius: 5px; background: white; cursor: pointer;">5 (é«˜)</button>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50;">
                            æ”¹å–„ç‚¹ãƒ»ã‚³ãƒ¡ãƒ³ãƒˆ
                        </label>
                        <textarea id="feedbackText" placeholder="å ±å‘Šæ›¸ã®æ”¹å–„ç‚¹ã‚„ã€ã‚ˆã‚Šè‰¯ã„è¡¨ç¾ã®ææ¡ˆãªã©ã‚’ãŠèã‹ã›ãã ã•ã„..." style="width: 100%; padding: 12px; border: 2px solid #e1e8ed; border-radius: 8px; font-family: inherit; resize: vertical; min-height: 100px;"></textarea>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50;">
                            å ±å‘Šæ›¸ã®ç‰¹å¾´
                        </label>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="checkbox" name="features" value="å…·ä½“çš„"> å…·ä½“çš„
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="checkbox" name="features" value="è‡ªç„¶"> è‡ªç„¶ãªæ–‡ä½“
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="checkbox" name="features" value="å»ºè¨­çš„"> å»ºè¨­çš„
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="checkbox" name="features" value="æŠ½è±¡çš„"> æŠ½è±¡çš„
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="checkbox" name="features" value="æ©Ÿæ¢°çš„"> æ©Ÿæ¢°çš„
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="checkbox" name="features" value="ä¸é©åˆ‡"> ä¸é©åˆ‡
                            </label>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button id="cancelFeedback" style="padding: 10px 20px; border: 2px solid #e1e8ed; border-radius: 8px; background: white; cursor: pointer;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        <button id="submitFeedback" style="padding: 10px 20px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯é€ä¿¡</button>
                    </div>
                `;
                
                modal.appendChild(modalContent);
                document.body.appendChild(modal);
                
                // è©•ä¾¡ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
                let selectedRating = 0;
                const ratingBtns = modal.querySelectorAll('.rating-btn');
                ratingBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        ratingBtns.forEach(b => {
                            b.style.background = 'white';
                            b.style.borderColor = '#e1e8ed';
                        });
                        btn.style.background = '#4facfe';
                        btn.style.borderColor = '#4facfe';
                        btn.style.color = 'white';
                        selectedRating = parseInt(btn.dataset.rating);
                    });
                });
                
                // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³
                modal.querySelector('#cancelFeedback').addEventListener('click', () => {
                    document.body.removeChild(modal);
                });
                
                // é€ä¿¡ãƒœã‚¿ãƒ³
                modal.querySelector('#submitFeedback').addEventListener('click', () => {
                    if (selectedRating === 0) {
                        alert('å“è³ªè©•ä¾¡ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                        return;
                    }
                    
                    const feedbackText = modal.querySelector('#feedbackText').value;
                    const selectedFeatures = Array.from(modal.querySelectorAll('input[name="features"]:checked'))
                        .map(cb => cb.value);
                    
                    // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                    const feedbackData = {
                        id: Date.now(),
                        date: new Date().toLocaleString('ja-JP'),
                        input: currentInput,
                        report: currentReport,
                        rating: selectedRating,
                        feedback: feedbackText,
                        features: selectedFeatures,
                        analysis: this.analyzeProgress(currentInput)
                    };
                    
                    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
                    const feedbacks = JSON.parse(localStorage.getItem('feedbacks') || '[]');
                    feedbacks.push(feedbackData);
                    localStorage.setItem('feedbacks', JSON.stringify(feedbacks));
                    
                    // æ©Ÿæ¢°å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦ã‚‚ä¿å­˜
                    this.saveMLData(feedbackData);
                    
                    document.body.removeChild(modal);
                                         this.showSuccess(`ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼è©•ä¾¡: ${selectedRating}/5 ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼`);
                     this.displayMLDataInfo(); // MLãƒ‡ãƒ¼ã‚¿æƒ…å ±ã‚’æ›´æ–°
                 });
             }

            showLoading(show) {
                const loading = document.getElementById('loading');
                const generateBtn = document.getElementById('generateBtn');
                
                if (show) {
                    loading.classList.add('show');
                    generateBtn.disabled = true;
                    generateBtn.textContent = 'AIåˆ†æä¸­...';
                } else {
                    loading.classList.remove('show');
                    generateBtn.disabled = false;
                    generateBtn.textContent = 'æ©Ÿæ¢°å­¦ç¿’ã§å ±å‘Šæ›¸ã‚’ç”Ÿæˆ';
                }
            }

            showError(message) {
                const error = document.getElementById('error');
                error.textContent = message;
                error.classList.add('show');
                error.scrollIntoView({ behavior: 'smooth' });
            }

            showSuccess(message) {
                const success = document.getElementById('success');
                success.textContent = message;
                success.classList.add('show');
                setTimeout(() => {
                    success.classList.remove('show');
                }, 3000);
            }

            hideMessages() {
                document.getElementById('error').classList.remove('show');
                document.getElementById('success').classList.remove('show');
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            saveMLData(feedbackData) {
                // æ©Ÿæ¢°å­¦ç¿’ç”¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                const mlData = JSON.parse(localStorage.getItem('mlTrainingData') || '[]');
                
                // ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦ä¿å­˜
                const trainingData = {
                    input: feedbackData.input,
                    output: feedbackData.report,
                    rating: feedbackData.rating,
                    features: feedbackData.features,
                    analysis: feedbackData.analysis,
                    timestamp: Date.now()
                };
                
                mlData.push(trainingData);
                localStorage.setItem('mlTrainingData', JSON.stringify(mlData));
                
                console.log('æ©Ÿæ¢°å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸ:', trainingData);
            }

            // æ©Ÿæ¢°å­¦ç¿’ãƒ¢ãƒ‡ãƒ«ã®æ”¹å–„ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆå°†æ¥çš„ã«å®Ÿè£…ï¼‰
            async improveModel() {
                const mlData = JSON.parse(localStorage.getItem('mlTrainingData') || '[]');
                
                if (mlData.length < 10) {
                    console.log('ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™ï¼ˆæœ€ä½10ä»¶å¿…è¦ï¼‰');
                    return;
                }
                
                console.log(`${mlData.length}ä»¶ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã§ãƒ¢ãƒ‡ãƒ«ã‚’æ”¹å–„ä¸­...`);
                
                // é«˜è©•ä¾¡ï¼ˆ4-5ç‚¹ï¼‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º
                const highQualityData = mlData.filter(data => data.rating >= 4);
                console.log(`é«˜å“è³ªãƒ‡ãƒ¼ã‚¿: ${highQualityData.length}ä»¶`);
                
                // ä½è©•ä¾¡ï¼ˆ1-2ç‚¹ï¼‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º
                const lowQualityData = mlData.filter(data => data.rating <= 2);
                console.log(`ä½å“è³ªãƒ‡ãƒ¼ã‚¿: ${lowQualityData.length}ä»¶`);
                
                // ç‰¹å¾´é‡ã®åˆ†æ
                const featureAnalysis = this.analyzeFeatures(mlData);
                console.log('ç‰¹å¾´é‡åˆ†æ:', featureAnalysis);
                
                // å°†æ¥çš„ã«ã¯å®Ÿéš›ã®ãƒ¢ãƒ‡ãƒ«å†å­¦ç¿’ã‚’ã“ã“ã§è¡Œã†
                this.showSuccess('æ©Ÿæ¢°å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã®åˆ†æãŒå®Œäº†ã—ã¾ã—ãŸã€‚ãƒ¢ãƒ‡ãƒ«ã®æ”¹å–„ã«æ´»ç”¨ã•ã‚Œã¾ã™ã€‚');
            }

            analyzeFeatures(mlData) {
                const analysis = {
                    totalSamples: mlData.length,
                    averageRating: 0,
                    featureCounts: {},
                    subjectDistribution: {},
                    qualityDistribution: {}
                };
                
                let totalRating = 0;
                
                mlData.forEach(data => {
                    totalRating += data.rating;
                    
                    // ç‰¹å¾´ã®é›†è¨ˆ
                    data.features.forEach(feature => {
                        analysis.featureCounts[feature] = (analysis.featureCounts[feature] || 0) + 1;
                    });
                    
                    // æ•™ç§‘ã®åˆ†å¸ƒ
                    const subjects = data.analysis.subjects;
                    subjects.forEach(subject => {
                        analysis.subjectDistribution[subject] = (analysis.subjectDistribution[subject] || 0) + 1;
                    });
                    
                    // å“è³ªåˆ†å¸ƒ
                    const quality = data.rating >= 4 ? 'é«˜å“è³ª' : data.rating <= 2 ? 'ä½å“è³ª' : 'æ™®é€š';
                    analysis.qualityDistribution[quality] = (analysis.qualityDistribution[quality] || 0) + 1;
                });
                
                analysis.averageRating = totalRating / mlData.length;
                
                return analysis;
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            new MLReportGenerator();
        });
    </script>
</body>
</html>
