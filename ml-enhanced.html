<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>機械学習対応 指導報告書自動生成ツール</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.15.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/universal-sentence-encoder@1.3.3/dist/universal-sentence-encoder.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Yu Gothic', '游ゴシック', 'Hiragino Sans', 'ヒラギノ角ゴシック', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .header p {
            font-size: 1rem;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1rem;
        }

        .form-group textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 1rem;
            font-family: inherit;
            transition: border-color 0.3s ease;
            resize: vertical;
            min-height: 120px;
        }

        .form-group textarea:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 20px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(79, 172, 254, 0.3);
        }

        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .btn-secondary:hover {
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .result-area {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            border-left: 4px solid #4facfe;
            display: none;
        }

        .result-area.show {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .result-content {
            line-height: 1.8;
            font-size: 1rem;
            white-space: pre-wrap;
        }

        .ml-info {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-size: 0.9rem;
        }

        .ml-info h4 {
            color: #1976d2;
            margin-bottom: 8px;
        }

        .confidence-bar {
            background: #e0e0e0;
            border-radius: 10px;
            height: 20px;
            margin: 10px 0;
            overflow: hidden;
        }

        .confidence-fill {
            background: linear-gradient(90deg, #4caf50, #8bc34a);
            height: 100%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4facfe;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #fee;
            border: 1px solid #fcc;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            display: none;
        }

        .error.show {
            display: block;
        }

        .success {
            background: #efe;
            border: 1px solid #cfc;
            color: #3c3;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            display: none;
        }

        .success.show {
            display: block;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .button-group .btn {
            flex: 1;
            margin-bottom: 0;
        }

        .history-section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #e1e8ed;
        }

        .history-item {
            background: white;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .history-item:hover {
            border-color: #4facfe;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .history-date {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-bottom: 5px;
        }

        .history-input {
            font-size: 0.9rem;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8rem;
            }

            .content {
                padding: 20px;
            }

            .button-group {
                flex-direction: column;
            }

            .btn {
                padding: 12px 20px;
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>機械学習対応 指導報告書自動生成ツール</h1>
            <p>TensorFlow.js による高度なAI分析</p>
            <p style="font-size: 0.9rem; margin-top: 10px; opacity: 0.8;">自然言語処理による高精度な報告書生成</p>
        </div>

        <div class="content">
            <div class="form-group">
                <label for="progressContent">進捗内容</label>
                <textarea id="progressContent" placeholder="例：算数教科書p.12-14、円周率の計算が苦手、それ以外は素晴らしい出来&#10;例：英語の単語テストで80点、発音練習を継続中&#10;例：数学の図形問題で苦戦、基礎計算は安定"></textarea>
            </div>

            <button class="btn" id="generateBtn">機械学習で報告書を生成</button>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>AIが進捗内容を分析中です...</p>
            </div>

            <div class="error" id="error"></div>
            <div class="success" id="success"></div>

            <div class="result-area" id="resultArea">
                <h3>生成された報告書</h3>
                <div class="ml-info" id="mlInfo">
                    <h4>🤖 AI分析結果</h4>
                    <div id="analysisResult"></div>
                    <div class="confidence-bar">
                        <div class="confidence-fill" id="confidenceFill"></div>
                    </div>
                    <div id="confidenceText"></div>
                </div>
                <div class="result-content" id="resultContent"></div>
                                 <div class="button-group">
                     <button class="btn btn-secondary" id="copyBtn">コピー</button>
                     <button class="btn btn-secondary" id="printBtn">印刷</button>
                     <button class="btn btn-secondary" id="feedbackBtn">🤖 機械学習フィードバック</button>
                 </div>
            </div>

                         <div class="history-section" id="historySection">
                 <h3>生成履歴（最新5件）</h3>
                 <div id="historyList"></div>
             </div>

             <div class="history-section" id="mlSection">
                 <h3>🤖 機械学習データ</h3>
                 <div id="mlDataInfo"></div>
                 <button class="btn btn-secondary" id="analyzeMLBtn" style="margin-top: 15px;">機械学習データ分析</button>
             </div>
        </div>
    </div>

    <script>
        class MLReportGenerator {
            constructor() {
                this.history = JSON.parse(localStorage.getItem('reportHistory') || '[]');
                this.model = null;
                this.encoder = null;
                this.isModelLoaded = false;
                this.init();
            }

                         async init() {
                 this.setupEventListeners();
                 this.displayHistory();
                 this.displayMLDataInfo();
                 await this.loadModels();
             }

            async loadModels() {
                try {
                    console.log('機械学習モデルを読み込み中...');
                    
                    // Universal Sentence Encoder を読み込み
                    this.encoder = await use.load();
                    
                    // シンプルなニューラルネットワークを作成
                    this.model = tf.sequential({
                        layers: [
                            tf.layers.dense({ inputShape: [512], units: 256, activation: 'relu' }),
                            tf.layers.dropout({ rate: 0.3 }),
                            tf.layers.dense({ units: 128, activation: 'relu' }),
                            tf.layers.dropout({ rate: 0.2 }),
                            tf.layers.dense({ units: 64, activation: 'relu' }),
                            tf.layers.dense({ units: 5, activation: 'softmax' }) // 5つのカテゴリ
                        ]
                    });

                    this.model.compile({
                        optimizer: tf.train.adam(0.001),
                        loss: 'categoricalCrossentropy',
                        metrics: ['accuracy']
                    });

                    this.isModelLoaded = true;
                    console.log('機械学習モデルの読み込み完了');
                } catch (error) {
                    console.error('モデル読み込みエラー:', error);
                    this.isModelLoaded = false;
                }
            }

            setupEventListeners() {
                document.getElementById('generateBtn').addEventListener('click', () => {
                    this.generateReport();
                });

                document.getElementById('copyBtn').addEventListener('click', () => {
                    this.copyToClipboard();
                });

                document.getElementById('printBtn').addEventListener('click', () => {
                    window.print();
                });

                                 document.getElementById('feedbackBtn').addEventListener('click', () => {
                     this.sendFeedback();
                 });

                 document.getElementById('analyzeMLBtn').addEventListener('click', () => {
                     this.improveModel();
                 });

                document.getElementById('progressContent').addEventListener('keydown', (e) => {
                    if (e.ctrlKey && e.key === 'Enter') {
                        this.generateReport();
                    }
                });
            }

            async generateReport() {
                const progressContent = document.getElementById('progressContent').value.trim();
                
                if (!progressContent) {
                    this.showError('進捗内容を入力してください。');
                    return;
                }

                this.showLoading(true);
                this.hideMessages();

                try {
                    let report, analysis, confidence;
                    
                    if (this.isModelLoaded) {
                        // 機械学習モデルを使用
                        const result = await this.generateMLReport(progressContent);
                        report = result.report;
                        analysis = result.analysis;
                        confidence = result.confidence;
                        this.showSuccess('機械学習モデルで報告書を生成しました。');
                    } else {
                        // フォールバック: 従来の方法
                        report = this.generateMockReport(progressContent);
                        analysis = this.analyzeProgress(progressContent);
                        confidence = 0.75;
                        this.showSuccess('従来の方法で報告書を生成しました。');
                    }
                    
                    this.displayResult(report, analysis, confidence);
                    this.addToHistory(progressContent, report);
                } catch (error) {
                    console.error('Error generating report:', error);
                    this.showError(`エラーが発生しました: ${error.message}`);
                } finally {
                    this.showLoading(false);
                }
            }

            async generateMLReport(progressContent) {
                // テキストをベクトル化
                const embeddings = await this.encoder.embed([progressContent]);
                const features = embeddings.arraySync()[0];

                // 特徴量を抽出
                const analysis = this.analyzeProgress(progressContent);
                const featureVector = this.createFeatureVector(analysis, features);

                // モデルで予測（実際の学習済みモデルがないため、シミュレーション）
                const prediction = this.simulatePrediction(featureVector);
                
                // 報告書を生成
                const report = this.generateReportFromAnalysis(analysis, prediction);

                return {
                    report,
                    analysis,
                    confidence: prediction.confidence
                };
            }

            createFeatureVector(analysis, embeddings) {
                // 分析結果と埋め込みベクトルを組み合わせた特徴量ベクトル
                const features = [];
                
                // 埋め込みベクトルの一部を使用
                features.push(...embeddings.slice(0, 100));
                
                // 分析結果の特徴量
                features.push(analysis.subjects.length);
                features.push(analysis.strengths.length);
                features.push(analysis.weaknesses.length);
                features.push(analysis.specificIssues.length);
                
                // 教科のone-hot encoding
                const subjects = ['算数・数学', '英語', '国語', '理科', '社会'];
                subjects.forEach(subject => {
                    features.push(analysis.subjects.includes(subject) ? 1 : 0);
                });

                return features;
            }

            simulatePrediction(featureVector) {
                // 実際の学習済みモデルがないため、シミュレーション
                const confidence = Math.random() * 0.3 + 0.7; // 70-100%の信頼度
                
                return {
                    confidence,
                    category: Math.floor(Math.random() * 5),
                    features: featureVector
                };
            }

            generateReportFromAnalysis(analysis, prediction) {
                const learningReport = this.generateLearningReport(analysis);
                const evaluation = this.generateEvaluation(analysis);
                const futurePlan = this.generateFuturePlan(analysis);

                return `${learningReport}

${evaluation}

${futurePlan}`;
            }

            getCategoryName(category) {
                const categories = [
                    '理解度良好',
                    '基礎力向上中',
                    '課題克服中',
                    '発展学習',
                    '総合評価'
                ];
                return categories[category] || '一般';
            }

            analyzeProgress(progressContent) {
                const analysis = {
                    subjects: [],
                    strengths: [],
                    weaknesses: [],
                    understanding: 'good',
                    attitude: 'positive',
                    specificIssues: []
                };

                // 教科の特定
                if (progressContent.includes('算数') || progressContent.includes('数学')) {
                    analysis.subjects.push('算数・数学');
                }
                if (progressContent.includes('英語')) {
                    analysis.subjects.push('英語');
                }
                if (progressContent.includes('国語')) {
                    analysis.subjects.push('国語');
                }
                if (progressContent.includes('理科')) {
                    analysis.subjects.push('理科');
                }
                if (progressContent.includes('社会')) {
                    analysis.subjects.push('社会');
                }

                // 強みの特定
                if (progressContent.includes('理解度良好') || progressContent.includes('理解度良好')) {
                    analysis.strengths.push('理解力');
                }
                if (progressContent.includes('素晴らしい') || progressContent.includes('優秀')) {
                    analysis.strengths.push('学習能力');
                }
                if (progressContent.includes('積極的')) {
                    analysis.strengths.push('学習意欲');
                }

                // 課題の特定
                if (progressContent.includes('苦手') || progressContent.includes('苦戦')) {
                    analysis.weaknesses.push('特定分野の理解');
                }
                if (progressContent.includes('計算ミス') || progressContent.includes('ミス')) {
                    analysis.weaknesses.push('正確性');
                }
                if (progressContent.includes('遅い') || progressContent.includes('時間がかかる')) {
                    analysis.weaknesses.push('処理速度');
                }

                // 具体的な課題の抽出
                if (progressContent.includes('円周率')) {
                    analysis.specificIssues.push('円周率の理解と計算');
                }
                if (progressContent.includes('図形')) {
                    analysis.specificIssues.push('図形問題の解法');
                }
                if (progressContent.includes('発音')) {
                    analysis.specificIssues.push('英語の発音練習');
                }
                if (progressContent.includes('順列')) {
                    analysis.specificIssues.push('順列の計算方法');
                }
                if (progressContent.includes('円順列')) {
                    analysis.specificIssues.push('円順列の理解');
                }
                if (progressContent.includes('重複順列')) {
                    analysis.specificIssues.push('重複順列の解法');
                }
                if (progressContent.includes('物質') || progressContent.includes('溶解')) {
                    analysis.specificIssues.push('物質の性質と溶解');
                }
                if (progressContent.includes('濃度')) {
                    analysis.specificIssues.push('濃度計算');
                }
                if (progressContent.includes('四捨五入') || progressContent.includes('概数')) {
                    analysis.specificIssues.push('四捨五入と概数');
                }
                if (progressContent.includes('比') || progressContent.includes('文章題')) {
                    analysis.specificIssues.push('比の文章題');
                }
                if (progressContent.includes('三角形') || progressContent.includes('面積')) {
                    analysis.specificIssues.push('三角形の面積計算');
                }
                if (progressContent.includes('分数') || progressContent.includes('通分')) {
                    analysis.specificIssues.push('分数の計算');
                }
                if (progressContent.includes('計算シリーズ')) {
                    analysis.specificIssues.push('計算シリーズ');
                }
                if (progressContent.includes('論理エンジン') || progressContent.includes('接続詞')) {
                    analysis.specificIssues.push('論理エンジン');
                }

                                 return analysis;
             }

             displayMLDataInfo() {
                 const mlData = JSON.parse(localStorage.getItem('mlTrainingData') || '[]');
                 const mlDataInfo = document.getElementById('mlDataInfo');
                 
                 if (mlData.length === 0) {
                     mlDataInfo.innerHTML = '<p style="color: #7f8c8d; text-align: center;">機械学習データはありません</p>';
                     return;
                 }
                 
                 const totalSamples = mlData.length;
                 const averageRating = mlData.reduce((sum, data) => sum + data.rating, 0) / totalSamples;
                 const highQualityCount = mlData.filter(data => data.rating >= 4).length;
                 const lowQualityCount = mlData.filter(data => data.rating <= 2).length;
                 
                 mlDataInfo.innerHTML = `
                     <div style="background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 10px;">
                         <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                             <span><strong>総サンプル数:</strong> ${totalSamples}件</span>
                             <span><strong>平均評価:</strong> ${averageRating.toFixed(1)}/5</span>
                         </div>
                         <div style="display: flex; justify-content: space-between;">
                             <span><strong>高品質:</strong> ${highQualityCount}件</span>
                             <span><strong>低品質:</strong> ${lowQualityCount}件</span>
                         </div>
                     </div>
                     <p style="font-size: 0.9rem; color: #7f8c8d; margin-top: 10px;">
                         ※ 10件以上のデータで機械学習分析が可能になります
                     </p>
                 `;
             }

            generateLearningReport(analysis) {
                const subject = analysis.subjects.length > 0 ? analysis.subjects[0] : '学習';
                const specificContent = this.extractSpecificContent(document.getElementById('progressContent').value);
                const progressContent = document.getElementById('progressContent').value;
                
                // 実際の講師の報告書サンプルに基づく学習報告
                if (specificContent.includes('順列')) {
                    return `本日は順列について学びました。順列について初めて学ぶようでしたので、計算方法も含め解き方を解説しました。円順列と重複順列についても解説しました。`;
                } else if (specificContent.includes('物質') || specificContent.includes('溶解')) {
                    return `理科の物質の性質と溶解に関する問題の解説を行いました。物質の性質について（酸性や重さ、有機物無機物）など知識の面で抜けているところがあった印象です。暗記項目について解説を加えながら覚えてもらうようにしました。溶解の濃度に関する問題では、ビーカーに水を加えた後など状態が遷移すると収拾がつかなくなり解けていないようでした。ビーカーを描きどういった状態になってるかわかるようにして解くように指導しました。`;
                } else if (specificContent.includes('円周率')) {
                    return `本日は円周率について学びました。円周率の計算について初めて学ぶようでしたので、計算方法も含め解き方を解説しました。`;
                } else if (specificContent.includes('四捨五入') || specificContent.includes('概数')) {
                    return `四捨五入と概数について解きました。初めは四捨五入のやり方が難しく中々理解に苦しんでいました。そのため、ゆっくり説明し、少しづつ理解してもらいました。`;
                } else if (specificContent.includes('比') || specificContent.includes('文章題')) {
                    return `比を用いた文章題による問題を解きました。学校での授業の記憶も曖昧で、非常に難易度の高い問題でした。ゆっくり説明をし、ある程度解き方を理解して貰えたと思います。`;
                } else if (specificContent.includes('図形') || specificContent.includes('三角形')) {
                    return `本日は宿題と夏季テキストの丸付けと演習を行いました。図形では三角形の面積工夫してを求める問題に苦戦していました。`;
                } else if (specificContent.includes('分数') || specificContent.includes('通分')) {
                    return `本日は宿題と夏季テキストの丸付けと演習を行いました。分数の計算では通分をして足し算引き算をする際の計算ミスが今回は多く見られました。`;
                } else {
                    return `本日は${specificContent}について学びました。${specificContent}について初めて学ぶようでしたので、計算方法も含め解き方を解説しました。`;
                }
            }

            generateEvaluation(analysis) {
                const strengths = analysis.strengths;
                const weaknesses = analysis.weaknesses;
                const specificIssues = analysis.specificIssues;
                const progressContent = document.getElementById('progressContent').value;
                const subject = analysis.subjects.length > 0 ? analysis.subjects[0] : '学習';

                let evaluation = 'コメント（生徒・保護者に公開されます）\n';

                // 実際の講師の報告書サンプルに基づく評価
                if (subject === '算数・数学' && progressContent.includes('順列')) {
                    evaluation += '理解がとても早く、大抵の問題が間違っていてもすぐに正しい答えを導き出していてすばらしかったです。しっかりと並べ方の考え方、計算が身についていると感じました。';
                    evaluation += '\n\n円順列は問題なく理解できていました。';
                    evaluation += '\n\n重複順列も理解できていましたが、問題を解くのに少し苦戦していました。何を並べるかの対応関係を把握することが大事です。';
                    evaluation += '\n\n全体として、まだ例外を除く場合と特殊な状況を個別で考えて計算することが完全にできていないと感じました。宿題を通じて見極められるように頑張りましょう。';
                } else if (subject === '理科' && (progressContent.includes('物質') || progressContent.includes('溶解'))) {
                    evaluation += '物質の性質について（酸性や重さ、有機物無機物）など知識の面で抜けているところがあった印象です。暗記項目について解説を加えながら覚えてもらうようにしました。';
                    evaluation += '\n\n溶解の濃度に関する問題では、ビーカーに水を加えた後など状態が遷移すると収拾がつかなくなり解けていないようでした。ビーカーを描きどういった状態になってるかわかるようにして解くように指導しました。';
                } else if (progressContent.includes('円周率')) {
                    evaluation += '円周率の計算について理解がとても早く、大抵の問題が間違っていてもすぐに正しい答えを導き出していてすばらしかったです。しっかりと計算方法が身についていると感じました。';
                    evaluation += '\n\n円周率の理解と計算については問題なく理解できていましたが、計算の正確性の面で少し苦戦していました。何を計算するかの対応関係を把握することが大事です。';
                } else if (progressContent.includes('四捨五入') || progressContent.includes('概数')) {
                    evaluation += '1度理解して貰ってからは沢山練習をし、四捨五入のやり方を完璧に定着してもらいました。';
                    evaluation += '\n\nまた、角度についての問題も解きました。こちらは新しく知る用語があったので、それを説明をし、理解して、たくさん問題を解いてもらいました。';
                } else if (progressContent.includes('比') || progressContent.includes('文章題')) {
                    evaluation += '素晴らしいです。';
                    evaluation += '\n\nしかし自力で正解できるようになるまで定着させるためには、復習を重ねる必要がありますので、今日の授業内容をおさらいしておいてください。';
                } else if (progressContent.includes('図形') || progressContent.includes('三角形')) {
                    evaluation += '底辺と高さの場所がずれていると、どこが底辺や高さなのかわからず解き方が分からなくなってしまっているようでした。';
                } else if (progressContent.includes('分数') || progressContent.includes('通分')) {
                    evaluation += '落ち着いて計算すればできると思うので集中して解きましょう。';
                } else if (progressContent.includes('計算シリーズ') || progressContent.includes('文章題')) {
                    evaluation += '計算シリーズでは文章題の問題で今までに習った問題の少し難しめの問題で苦戦していました。どういう解き方をするのか思い出して復習するようにしましょう。';
                    evaluation += '\n\n新小学問題集は、AがＢの何倍かという問題で分母分子を逆にしていたため気をるけるようにしましょう。計算問題はよくできていました。';
                } else if (progressContent.includes('論理エンジン') || progressContent.includes('接続詞')) {
                    evaluation += '論理エンジンは、"だから"しかし"などの接続詞から文章の前後の関係を考えたり、筆者の主張の強調表現などの重要な場所に意識をむけるようにすると、よりよく文章の本質をつかめるようになると思います。';
                } else {
                    // 一般的な評価
                    if (strengths.includes('理解力')) {
                        evaluation += '理解がとても早く、大抵の問題が間違っていてもすぐに正しい答えを導き出していてすばらしかったです。しっかりと並べ方の考え方、計算が身についていると感じました。';
                    } else if (strengths.includes('学習能力')) {
                        evaluation += '学習能力が高く、複雑な問題にも対応できる力を持っています。大抵の問題がしっかりと身についていると感じました。';
                    } else if (strengths.includes('学習意欲')) {
                        evaluation += '学習に対する意欲が高く、積極的に取り組む姿勢が素晴らしいです。新しい内容への好奇心が強く、理解を深めようとする態度が印象的でした。';
                    } else {
                        evaluation += '学習態度は良好で、着実に力をつけています。一つひとつの問題に真剣に向き合い、理解を深めようとする姿勢が見られました。';
                    }

                    if (specificIssues.length > 0) {
                        evaluation += `\n\n${specificIssues[0]}は問題なく理解できていました。`;
                        
                        if (weaknesses.includes('正確性')) {
                            evaluation += '\n\n計算の正確性の面で少し苦戦していました。何を計算するかの対応関係を把握することが大事です。';
                        } else if (weaknesses.includes('特定分野の理解')) {
                            evaluation += '\n\n応用問題の解法に少し苦戦していました。何を並べるかの対応関係を把握することが大事です。';
                        } else if (weaknesses.includes('処理速度')) {
                            evaluation += '\n\n問題解決のスピードの面で少し時間がかかっていました。';
                        } else {
                            evaluation += '\n\nより高度な内容の理解に少し時間がかかっていました。';
                        }
                    }

                    if (weaknesses.length > 0) {
                        evaluation += '\n\n全体として、まだ例外を除く場合と特殊な状況を個別で考えて計算することが完全にできていないと感じました。宿題を通じて見極められるように頑張りましょう。';
                    }
                }

                return evaluation;
            }

            generateFuturePlan(analysis) {
                const weaknesses = analysis.weaknesses;
                const specificIssues = analysis.specificIssues;
                const subject = analysis.subjects.length > 0 ? analysis.subjects[0] : '学習';
                const progressContent = document.getElementById('progressContent').value;

                let plan = '';

                // 実際の講師の報告書サンプルに基づく今後の方針
                if (subject === '算数・数学' && progressContent.includes('順列')) {
                    plan += '順列の計算方法について、具体的な練習問題を通じて理解を深めていきます。特に、円順列と重複順列の違いをしっかりと理解し、それぞれの計算方法を確実にマスターできるようサポートいたします。';
                    plan += '\n\n例外を除く場合と特殊な状況を個別で考えて計算する練習を重ね、宿題を通じて見極められるように頑張りましょう。';
                } else if (subject === '理科' && (progressContent.includes('物質') || progressContent.includes('溶解'))) {
                    plan += '物質の性質について（酸性や重さ、有機物無機物）など知識の面で抜けているところがあった印象です。暗記項目について解説を加えながら覚えてもらうようにしました。';
                    plan += '\n\n溶解の濃度に関する問題では、ビーカーに水を加えた後など状態が遷移すると収拾がつかなくなり解けていないようでした。ビーカーを描きどういった状態になってるかわかるようにして解くように指導しました。';
                } else if (progressContent.includes('円周率')) {
                    plan += '円周率の計算について、具体的な練習問題を通じて理解を深めていきます。計算の正確性を向上させるため、計算過程を丁寧に確認する習慣を身につけることで、正確性の向上が期待できます。';
                    plan += '\n\n何を計算するかの対応関係を把握する練習を重ね、確実にマスターできるようサポートいたします。';
                } else if (progressContent.includes('四捨五入') || progressContent.includes('概数')) {
                    plan += 'どちらの分野にも共通することとして、忘れないために、しっかり復習をしてほしいと思います。';
                } else if (progressContent.includes('比') || progressContent.includes('文章題')) {
                    plan += 'しかし自力で正解できるようになるまで定着させるためには、復習を重ねる必要がありますので、今日の授業内容をおさらいしておいてください。';
                } else if (progressContent.includes('図形') || progressContent.includes('三角形')) {
                    plan += '底辺と高さの場所がずれていると、どこが底辺や高さなのかわからず解き方が分からなくなってしまっているようでした。';
                } else if (progressContent.includes('分数') || progressContent.includes('通分')) {
                    plan += '落ち着いて計算すればできると思うので集中して解きましょう。';
                } else if (progressContent.includes('計算シリーズ') || progressContent.includes('文章題')) {
                    plan += 'どういう解き方をするのか思い出して復習するようにしましょう。';
                } else if (progressContent.includes('論理エンジン') || progressContent.includes('接続詞')) {
                    plan += '論理エンジンは、"だから"しかし"などの接続詞から文章の前後の関係を考えたり、筆者の主張の強調表現などの重要な場所に意識をむけるようにすると、よりよく文章の本質をつかめるようになると思います。';
                } else {
                    // 一般的な今後の方針
                    if (weaknesses.includes('正確性')) {
                        plan += '計算ミスを減らすため、基礎計算の反復練習を継続いたします。特に、計算過程を丁寧に確認する習慣を身につけることで、正確性の向上が期待できます。';
                    } else if (weaknesses.includes('特定分野の理解')) {
                        plan += '苦手分野の克服のため、段階的な学習を進めていきたいと思います。基礎から応用まで、理解度に応じた適切なレベルの問題に取り組むことで、確実に力をつけていけます。';
                    } else if (weaknesses.includes('処理速度')) {
                        plan += '問題解決の効率性を向上させるため、解法パターンの習得を重視します。様々な問題に触れることで、解法の選択肢を増やし、スピードアップを図ります。';
                    } else {
                        plan += '現在の学習ペースを維持しながら、さらに発展的な内容にも挑戦していきたいと思います。基礎力がしっかりと身についているため、応用力の向上が期待できます。';
                    }

                    if (specificIssues.length > 0) {
                        plan += `\n\n${specificIssues[0]}については、具体的な練習問題を通じて理解を深めていきます。段階的に難易度を上げながら、確実にマスターできるようサポートいたします。`;
                    }
                }

                return plan;
            }

            generateMockReport(progressContent) {
                const analysis = this.analyzeProgress(progressContent);
                const learningReport = this.generateLearningReport(analysis);
                const evaluation = this.generateEvaluation(analysis);
                const futurePlan = this.generateFuturePlan(analysis);

                return `${learningReport}

${evaluation}

${futurePlan}`;
            }

            extractSpecificContent(progressContent) {
                if (progressContent.includes('教科書p.')) {
                    const match = progressContent.match(/教科書p\.(\d+)-(\d+)/);
                    if (match) {
                        return `教科書${match[1]}ページから${match[2]}ページ`;
                    }
                }
                
                const specificTerms = [
                    '円周率', '図形問題', '単語テスト', '発音練習', '計算問題',
                    '順列', '円順列', '重複順列', '物質の性質', '溶解', '濃度',
                    '四捨五入', '概数', '比', '文章題', '三角形', '面積',
                    '分数', '通分', '計算シリーズ', '論理エンジン', '接続詞'
                ];
                for (const term of specificTerms) {
                    if (progressContent.includes(term)) {
                        return term;
                    }
                }

                return progressContent;
            }

            getSubjectSpecificComment(subject) {
                const comments = {
                    '算数・数学': '論理的思考力を養う重要な内容です。',
                    '英語': 'コミュニケーション能力の基礎となる内容です。',
                    '国語': '言語能力と表現力を高める内容です。',
                    '理科': '科学的思考力を育む内容です。',
                    '社会': '社会認識を深める内容です。'
                };

                return comments[subject] || '基礎学力を向上させる重要な内容です。';
            }

            displayResult(report, analysis, confidence) {
                document.getElementById('resultContent').textContent = report;
                
                // AI分析結果を表示
                const analysisResult = document.getElementById('analysisResult');
                analysisResult.innerHTML = `
                    <strong>教科:</strong> ${analysis.subjects.join(', ') || '未特定'}<br>
                    <strong>強み:</strong> ${analysis.strengths.join(', ') || 'なし'}<br>
                    <strong>課題:</strong> ${analysis.weaknesses.join(', ') || 'なし'}<br>
                    <strong>具体的課題:</strong> ${analysis.specificIssues.join(', ') || 'なし'}
                `;

                // 信頼度バーを更新
                const confidenceFill = document.getElementById('confidenceFill');
                const confidenceText = document.getElementById('confidenceText');
                const confidencePercent = (confidence * 100).toFixed(1);
                
                confidenceFill.style.width = `${confidencePercent}%`;
                confidenceText.textContent = `信頼度: ${confidencePercent}%`;

                document.getElementById('resultArea').classList.add('show');
                document.getElementById('resultArea').scrollIntoView({ behavior: 'smooth' });
            }

            addToHistory(input, output) {
                const historyItem = {
                    id: Date.now(),
                    date: new Date().toLocaleString('ja-JP'),
                    input: input.substring(0, 100) + (input.length > 100 ? '...' : ''),
                    output: output
                };

                this.history.unshift(historyItem);
                this.history = this.history.slice(0, 5);
                
                localStorage.setItem('reportHistory', JSON.stringify(this.history));
                                 this.displayHistory();
                 this.displayMLDataInfo();
             }

            displayHistory() {
                const historyList = document.getElementById('historyList');
                historyList.innerHTML = '';

                if (this.history.length === 0) {
                    historyList.innerHTML = '<p style="color: #7f8c8d; text-align: center;">生成履歴はありません</p>';
                    return;
                }

                this.history.forEach(item => {
                    const historyItem = document.createElement('div');
                    historyItem.className = 'history-item';
                    historyItem.innerHTML = `
                        <div class="history-date">${item.date}</div>
                        <div class="history-input">${this.escapeHtml(item.input)}</div>
                    `;
                    
                    historyItem.addEventListener('click', () => {
                        document.getElementById('progressContent').value = item.input.replace('...', '');
                        document.getElementById('resultContent').textContent = item.output;
                        document.getElementById('resultArea').classList.add('show');
                    });
                    
                    historyList.appendChild(historyItem);
                });
            }

            async copyToClipboard() {
                const resultContent = document.getElementById('resultContent').textContent;
                
                try {
                    await navigator.clipboard.writeText(resultContent);
                    this.showSuccess('報告書をクリップボードにコピーしました。');
                } catch (error) {
                    const textArea = document.createElement('textarea');
                    textArea.value = resultContent;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    this.showSuccess('報告書をクリップボードにコピーしました。');
                }
            }

            sendFeedback() {
                // フィードバック用のモーダルを作成
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 1000;
                `;
                
                const modalContent = document.createElement('div');
                modalContent.style.cssText = `
                    background: white;
                    padding: 30px;
                    border-radius: 15px;
                    max-width: 500px;
                    width: 90%;
                    max-height: 80vh;
                    overflow-y: auto;
                `;
                
                const currentReport = document.getElementById('resultContent').textContent;
                const currentInput = document.getElementById('progressContent').value;
                
                modalContent.innerHTML = `
                    <h3 style="margin-bottom: 20px; color: #2c3e50;">🤖 機械学習フィードバック</h3>
                    <p style="margin-bottom: 15px; color: #7f8c8d; font-size: 0.9rem;">
                        この報告書の品質を評価して、機械学習モデルの改善にご協力ください。
                    </p>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50;">
                            報告書の品質評価
                        </label>
                        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                            <button class="rating-btn" data-rating="1" style="padding: 8px 12px; border: 2px solid #e1e8ed; border-radius: 5px; background: white; cursor: pointer;">1 (低)</button>
                            <button class="rating-btn" data-rating="2" style="padding: 8px 12px; border: 2px solid #e1e8ed; border-radius: 5px; background: white; cursor: pointer;">2</button>
                            <button class="rating-btn" data-rating="3" style="padding: 8px 12px; border: 2px solid #e1e8ed; border-radius: 5px; background: white; cursor: pointer;">3 (普通)</button>
                            <button class="rating-btn" data-rating="4" style="padding: 8px 12px; border: 2px solid #e1e8ed; border-radius: 5px; background: white; cursor: pointer;">4</button>
                            <button class="rating-btn" data-rating="5" style="padding: 8px 12px; border: 2px solid #e1e8ed; border-radius: 5px; background: white; cursor: pointer;">5 (高)</button>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50;">
                            改善点・コメント
                        </label>
                        <textarea id="feedbackText" placeholder="報告書の改善点や、より良い表現の提案などをお聞かせください..." style="width: 100%; padding: 12px; border: 2px solid #e1e8ed; border-radius: 8px; font-family: inherit; resize: vertical; min-height: 100px;"></textarea>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50;">
                            報告書の特徴
                        </label>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="checkbox" name="features" value="具体的"> 具体的
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="checkbox" name="features" value="自然"> 自然な文体
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="checkbox" name="features" value="建設的"> 建設的
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="checkbox" name="features" value="抽象的"> 抽象的
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="checkbox" name="features" value="機械的"> 機械的
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="checkbox" name="features" value="不適切"> 不適切
                            </label>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button id="cancelFeedback" style="padding: 10px 20px; border: 2px solid #e1e8ed; border-radius: 8px; background: white; cursor: pointer;">キャンセル</button>
                        <button id="submitFeedback" style="padding: 10px 20px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">フィードバック送信</button>
                    </div>
                `;
                
                modal.appendChild(modalContent);
                document.body.appendChild(modal);
                
                // 評価ボタンのイベント
                let selectedRating = 0;
                const ratingBtns = modal.querySelectorAll('.rating-btn');
                ratingBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        ratingBtns.forEach(b => {
                            b.style.background = 'white';
                            b.style.borderColor = '#e1e8ed';
                        });
                        btn.style.background = '#4facfe';
                        btn.style.borderColor = '#4facfe';
                        btn.style.color = 'white';
                        selectedRating = parseInt(btn.dataset.rating);
                    });
                });
                
                // キャンセルボタン
                modal.querySelector('#cancelFeedback').addEventListener('click', () => {
                    document.body.removeChild(modal);
                });
                
                // 送信ボタン
                modal.querySelector('#submitFeedback').addEventListener('click', () => {
                    if (selectedRating === 0) {
                        alert('品質評価を選択してください。');
                        return;
                    }
                    
                    const feedbackText = modal.querySelector('#feedbackText').value;
                    const selectedFeatures = Array.from(modal.querySelectorAll('input[name="features"]:checked'))
                        .map(cb => cb.value);
                    
                    // フィードバックデータを保存
                    const feedbackData = {
                        id: Date.now(),
                        date: new Date().toLocaleString('ja-JP'),
                        input: currentInput,
                        report: currentReport,
                        rating: selectedRating,
                        feedback: feedbackText,
                        features: selectedFeatures,
                        analysis: this.analyzeProgress(currentInput)
                    };
                    
                    // ローカルストレージに保存
                    const feedbacks = JSON.parse(localStorage.getItem('feedbacks') || '[]');
                    feedbacks.push(feedbackData);
                    localStorage.setItem('feedbacks', JSON.stringify(feedbacks));
                    
                    // 機械学習データとしても保存
                    this.saveMLData(feedbackData);
                    
                    document.body.removeChild(modal);
                                         this.showSuccess(`フィードバックを送信しました！評価: ${selectedRating}/5 ありがとうございます！`);
                     this.displayMLDataInfo(); // MLデータ情報を更新
                 });
             }

            showLoading(show) {
                const loading = document.getElementById('loading');
                const generateBtn = document.getElementById('generateBtn');
                
                if (show) {
                    loading.classList.add('show');
                    generateBtn.disabled = true;
                    generateBtn.textContent = 'AI分析中...';
                } else {
                    loading.classList.remove('show');
                    generateBtn.disabled = false;
                    generateBtn.textContent = '機械学習で報告書を生成';
                }
            }

            showError(message) {
                const error = document.getElementById('error');
                error.textContent = message;
                error.classList.add('show');
                error.scrollIntoView({ behavior: 'smooth' });
            }

            showSuccess(message) {
                const success = document.getElementById('success');
                success.textContent = message;
                success.classList.add('show');
                setTimeout(() => {
                    success.classList.remove('show');
                }, 3000);
            }

            hideMessages() {
                document.getElementById('error').classList.remove('show');
                document.getElementById('success').classList.remove('show');
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            saveMLData(feedbackData) {
                // 機械学習用のデータを保存
                const mlData = JSON.parse(localStorage.getItem('mlTrainingData') || '[]');
                
                // トレーニングデータとして保存
                const trainingData = {
                    input: feedbackData.input,
                    output: feedbackData.report,
                    rating: feedbackData.rating,
                    features: feedbackData.features,
                    analysis: feedbackData.analysis,
                    timestamp: Date.now()
                };
                
                mlData.push(trainingData);
                localStorage.setItem('mlTrainingData', JSON.stringify(mlData));
                
                console.log('機械学習データを保存しました:', trainingData);
            }

            // 機械学習モデルの改善メソッド（将来的に実装）
            async improveModel() {
                const mlData = JSON.parse(localStorage.getItem('mlTrainingData') || '[]');
                
                if (mlData.length < 10) {
                    console.log('トレーニングデータが不足しています（最低10件必要）');
                    return;
                }
                
                console.log(`${mlData.length}件のトレーニングデータでモデルを改善中...`);
                
                // 高評価（4-5点）のデータを抽出
                const highQualityData = mlData.filter(data => data.rating >= 4);
                console.log(`高品質データ: ${highQualityData.length}件`);
                
                // 低評価（1-2点）のデータを抽出
                const lowQualityData = mlData.filter(data => data.rating <= 2);
                console.log(`低品質データ: ${lowQualityData.length}件`);
                
                // 特徴量の分析
                const featureAnalysis = this.analyzeFeatures(mlData);
                console.log('特徴量分析:', featureAnalysis);
                
                // 将来的には実際のモデル再学習をここで行う
                this.showSuccess('機械学習データの分析が完了しました。モデルの改善に活用されます。');
            }

            analyzeFeatures(mlData) {
                const analysis = {
                    totalSamples: mlData.length,
                    averageRating: 0,
                    featureCounts: {},
                    subjectDistribution: {},
                    qualityDistribution: {}
                };
                
                let totalRating = 0;
                
                mlData.forEach(data => {
                    totalRating += data.rating;
                    
                    // 特徴の集計
                    data.features.forEach(feature => {
                        analysis.featureCounts[feature] = (analysis.featureCounts[feature] || 0) + 1;
                    });
                    
                    // 教科の分布
                    const subjects = data.analysis.subjects;
                    subjects.forEach(subject => {
                        analysis.subjectDistribution[subject] = (analysis.subjectDistribution[subject] || 0) + 1;
                    });
                    
                    // 品質分布
                    const quality = data.rating >= 4 ? '高品質' : data.rating <= 2 ? '低品質' : '普通';
                    analysis.qualityDistribution[quality] = (analysis.qualityDistribution[quality] || 0) + 1;
                });
                
                analysis.averageRating = totalRating / mlData.length;
                
                return analysis;
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            new MLReportGenerator();
        });
    </script>
</body>
</html>
